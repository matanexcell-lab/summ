<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>×¡×™×›×•× ×©×™×—×”</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: #f3f4f6;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .app-wrapper {
      width: 100%;
      max-width: 480px;
      padding: 24px 12px 40px;
    }
    .card {
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 8px 30px rgba(15, 23, 42, 0.12);
      padding: 24px 20px 16px;
    }
    h1 {
      margin: 0 0 12px;
      text-align: center;
      font-size: 26px;
      font-weight: 800;
    }
    .subtitle {
      text-align: center;
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 12px;
    }
    .step-indicator {
      text-align: center;
      font-size: 13px;
      color: #4b5563;
      margin-bottom: 8px;
    }
    .question-title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .field-label {
      font-size: 14px;
      margin-bottom: 6px;
      color: #374151;
    }
    select,
    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 10px 11px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 15px;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s;
      background-color: #fff;
    }
    select:focus,
    input:focus,
    textarea:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.6);
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    .buttons-row {
      display: flex;
      gap: 10px;
      margin-top: 14px;
    }
    .btn {
      flex: 1;
      border: none;
      border-radius: 999px;
      padding: 11px 0;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s, transform 0.05s, box-shadow 0.15s;
    }
    .btn-primary {
      background: #2563eb;
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .btn-small {
      flex: 0 0 auto;
      padding-inline: 14px;
      font-size: 13px;
      margin-top: 6px;
    }
    .btn-primary:active,
    .btn-secondary:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .helper-text {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
    .error-text {
      font-size: 13px;
      color: #b91c1c;
      margin-top: 6px;
    }
    .summary-box {
      margin-top: 18px;
      background: #111827;
      color: #f9fafb;
      border-radius: 16px;
      padding: 16px 14px;
      white-space: pre-wrap;
      font-size: 14px;
      direction: rtl;
    }
    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .mode-pill {
      font-size: 11px;
      padding: 2px 10px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="app-wrapper">
    <div class="card">
      <div class="top-row">
        <h1>×¡×™×›×•× ×©×™×—×”</h1>
        <span id="modePill" class="mode-pill hidden"></span>
      </div>
      <div id="subtitle" class="subtitle"></div>
      <div id="stepIndicator" class="step-indicator"></div>
      <div id="formContainer"></div>
      <div class="buttons-row">
        <button id="backBtn" class="btn btn-secondary">×—×–×¨×”</button>
        <button id="nextBtn" class="btn btn-primary">×”××©×š</button>
      </div>
      <button id="copyBtn" class="btn btn-secondary btn-small hidden" style="margin-top:10px;width:100%;">
        ×”×¢×ª×§ ×¡×™×›×•×
      </button>
      <div id="summaryBox" class="summary-box hidden"></div>
    </div>
  </div>

  <script>
    // =====================
    // × ×ª×•× ×™× ×§×‘×•×¢×™×
    // =====================

    const ACTION_TYPES = ["× ×™×•×“", "×”×©××¨×”", "×¤×ª×™×—×ª ×§×•×¤×”", "×¤×¨×˜"];

    const INVEST_COMPANIES = [
      "××’×“×œ","×›×œ×œ","×”×¨××œ","××œ×˜×©×•×œ×¨ ×©×—×","×™×œ×™×Ÿ ×œ×¤×™×“×•×ª","×× ×œ×™×¡×˜","××™×˜×‘","××•×¨",
      "×”×¤× ×™×§×¡","×”×›×©×¨×”","×× ×•×¨×”","××™×™×œ×•×Ÿ","×‘×™×˜×•×— ×™×©×™×¨"
    ];

    const INSURANCE_COMPANIES = [
      "××’×“×œ","×›×œ×œ","×”×¨××œ","×”×¤× ×™×§×¡","×”×›×©×¨×”","×× ×•×¨×”","××™×™×œ×•×Ÿ","×‘×™×˜×•×— ×™×©×™×¨"
    ];

    const PRODUCTS = ["×§×¨×Ÿ ×¤× ×¡×™×”", "×§×¨×Ÿ ×”×©×ª×œ××•×ª", "×§×•×¤×ª ×’××œ", "×§×•×¤×ª ×’××œ ×œ×”×©×§×¢×”"];

    // âœ… ××•×¦×¨×™× ×©×¦×¨×™×›×™× ××¡×š "××•×¤×™ ×”×¤×§×“×”"
    const DEPOSIT_PRODUCTS = ["×§×¨×Ÿ ×”×©×ª×œ××•×ª", "×§×•×¤×ª ×’××œ", "×§×•×¤×ª ×’××œ ×œ×”×©×§×¢×”"];

    const PRIVATE_PRODUCTS = [
      "×¤×•×œ×™×¡×ª ×—×™×™×",
      "×¤×•×œ×™×¡×ª ×—×™×™× ××©×•×¢×‘×“×ª",
      "×¤×•×œ×™×¡×ª ××©×›× ×ª×",
      "×‘×™×˜×•×— ×‘×¨×™××•×ª",
      "×‘×™×˜×•×— ×‘×¨×™××•×ª ×•××—×œ×•×ª ×§×©×•×ª",
      "×‘×™×˜×•×— ××—×œ×•×ª ×§×©×•×ª"
    ];

    const PRIVATE_ACTIONS = [
      "×‘×™×˜×•×œ",
      "×”×©××¨×”",
      "×”×¤×§×”",
      "××™× ×•×™ ×¡×•×›×Ÿ",
      "×‘×™×˜×•×œ ×•×”×¤×§×” ×—×“×©×”"
    ];

    const BASE_TRACKS = [
      "×›×œ×œ×™","×œ×‘× ×™ 50 ×•××˜×”","×œ×‘× ×™ 50-60","×œ×‘× ×™ 60 ×•××¢×œ×”","×× ×™×•×ª","Snp500",
      "××©×•×œ×‘ ×¡×—×™×¨","×¢×•×§×‘ ××“×“×™× ×’××™×©","×× ×™×•×ª ×¡×—×™×¨","×¢×•×§×‘ ××“×“×™ ×× ×™×•×ª",
      "×”×©×œ×•×© ×”×§×“×•×©","×—×¦×™ ×—×¦×™ ×× ×œ×™×¡×˜"
    ];

    const SPECIAL_TRACK_OUTPUT = {
      "×”×©×œ×•×© ×”×§×“×•×©": "33% ××©×•×œ×‘ ×¡×—×™×¨, 33% ××“×“×™ ×× ×™×•×ª, 34% Snp500",
      "×—×¦×™ ×—×¦×™ ×× ×œ×™×¡×˜": "50% ×¢×•×§×‘ ××“×“×™× ×’××™×©, 50% Snp500"
    };

    const EMPLOYMENT_TYPES = ["×©×›×™×¨×”", "×¢×¦×××™×ª", "×œ×œ×"];

    const MODE_SUMMARY = "×¡×™×›×•× ×”×“×‘×¨×™×";
    const MODE_RECOMMENDATION = "×”××œ×¦×•×ª";

    const HEBREW_LETTERS = "××‘×’×“×”×•×–×—×˜×™×›×œ×× ×¡×¢×¤×¦×§×¨×©×ª".split("");

    // =====================
    // ×¡×˜×™×™×˜ ×’×œ×•×‘×œ×™
    // =====================

    let mode = MODE_SUMMARY;
    let totalActions = 1;
    let currentActionIndex = 0;
    let currentStep = "mode";
    let history = [];

    const actions = [];

    // =====================
    // ×¢×–×¨×™×
    // =====================

    function getCurrentAction() {
      if (!actions[currentActionIndex]) {
        actions[currentActionIndex] = {
          index: currentActionIndex,
          type: null,
          reasons: []
        };
      }
      return actions[currentActionIndex];
    }

    function setSubtitle(text) {
      document.getElementById("subtitle").textContent = text || "";
    }

    function setStepIndicator() {
      const el = document.getElementById("stepIndicator");
      if (currentStep === "mode" || currentStep === "totalActions" || currentStep === "summary") {
        el.textContent = "";
        return;
      }
      el.textContent = `×¤×¢×•×œ×” ${currentActionIndex + 1} ××ª×•×š ${totalActions}`;
    }

    function setModePill() {
      const pill = document.getElementById("modePill");
      pill.classList.remove("hidden");
      pill.textContent = mode === MODE_SUMMARY ? "××¦×‘: ×¡×™×›×•× ×“×‘×¨×™×" : "××¦×‘: ×”××œ×¦×•×ª";
    }

    function createSelect(id, options, value) {
      const htmlOptions = options
        .map((opt) => `<option value="${opt}" ${opt === value ? "selected" : ""}>${opt}</option>`)
        .join("");
      return `<select id="${id}">
        <option value="">×‘×—×¨...</option>
        ${htmlOptions}
        <option value="××—×¨" ${value === "××—×¨" ? "selected" : ""}>××—×¨...</option>
      </select>`;
    }

    function getValue(id) {
      const el = document.getElementById(id);
      return el ? el.value.trim() : "";
    }

    function formatTrack(track) {
      if (SPECIAL_TRACK_OUTPUT[track]) return SPECIAL_TRACK_OUTPUT[track];
      return track;
    }

    function formatCompanyWithOther(selected, other) {
      if (selected === "××—×¨") return other || "";
      return selected || "";
    }

    function resolveProduct(a) {
      return (a.product === "××—×¨" ? (a.productOther || "") : (a.product || ""));
    }

    // =====================
    // ×¨× ×“×¨ ×œ×¦×¢×“
    // =====================

    function render() {
      const container = document.getElementById("formContainer");
      const summaryBox = document.getElementById("summaryBox");
      const copyBtn = document.getElementById("copyBtn");

      summaryBox.classList.add("hidden");
      summaryBox.textContent = "";
      copyBtn.classList.add("hidden");

      setStepIndicator();
      setModePill();

      let html = "";
      const action = getCurrentAction();

      switch (currentStep) {
        case "mode":
          setSubtitle("");
          html += `<div class="question-title">×”×× ×–×” ×¡×™×›×•× ×©×œ ×”×“×‘×¨×™× ××• ×”××œ×¦×•×ª?</div>`;
          html += createSelect("modeSelect", [MODE_SUMMARY, MODE_RECOMMENDATION], mode);
          if (mode === MODE_RECOMMENDATION) {
            html += `<div class="helper-text">×‘××¦×‘ ×”××œ×¦×•×ª × ×™×ª×Ÿ ×œ×”×•×¡×™×£ × ×™××•×§×™× ××—×¨×™ ×›×œ ×¤×¢×•×œ×”.</div>`;
          }
          break;

        case "totalActions":
          setSubtitle("");
          html += `<div class="question-title">×›××” ×¤×¢×•×œ×•×ª ××ª×” ×¨×•×¦×” ×œ×¨×©×•×?</div>`;
          html += `<input type="number" id="actionsCount" min="1" max="20" value="${totalActions}" />`;
          html += `<div class="helper-text">××¤×©×¨ ×œ×©× ×•×ª ××—×¨ ×›×š ×× ×¦×¨×™×š.</div>`;
          break;

        case "actionType":
          setSubtitle("×‘×—×¨ ××ª ×¡×•×’ ×”×¤×¢×•×œ×”");
          html += `<div class="question-title">××” ×¡×•×’ ×”×¤×¢×•×œ×”?</div>`;
          html += createSelect("actionTypeSelect", ACTION_TYPES, action.type);
          break;

        // ===== ×¤× ×¡×™×•× ×™ / ×”×©×§×¢×•×ª =====
        case "company":
          setSubtitle("×¤×¨×˜×™ ×”×—×‘×¨×” ×•×”××•×¦×¨");
          html += `<div class="field-label">××” ×©× ×”×—×‘×¨×”?</div>`;
          html += createSelect("companySelect", INVEST_COMPANIES, action.company);
          html += `<input type="text" id="companyOther" class="${action.company === "××—×¨" ? "" : "hidden"}"
                  placeholder="×©× ×”×—×‘×¨×” (×× × ×‘×—×¨ '××—×¨')" style="margin-top:6px;" value="${action.companyOther || ""}" />`;
          break;

        case "product":
          setSubtitle("×¤×¨×˜×™ ×”×—×‘×¨×” ×•×”××•×¦×¨");
          html += `<div class="field-label">××” ×¡×•×’ ×”××•×¦×¨?</div>`;
          html += createSelect("productSelect", PRODUCTS, action.product);
          html += `<input type="text" id="productOther" class="${action.product === "××—×¨" ? "" : "hidden"}"
                  placeholder="×¡×•×’ ××•×¦×¨ (×× × ×‘×—×¨ '××—×¨')" style="margin-top:6px;" value="${action.productOther || ""}" />`;
          break;

        case "employment":
          setSubtitle("××¦×‘ ×ª×¢×¡×•×§×ª×™");
          html += `<div class="field-label">×”×× ×”×œ×§×•×— ×©×›×™×¨, ×¢×¦×××™ ××• ×œ×œ×?</div>`;
          html += createSelect("employmentSelect", EMPLOYMENT_TYPES, action.employmentType);
          html += `<input type="text" id="employerName" class="${action.employmentType === "×©×›×™×¨×”" ? "" : "hidden"}"
                  placeholder="×©× ×”××¢×¡×™×§ (×× ×©×›×™×¨×”)" style="margin-top:6px;" value="${action.employerName || ""}">`;
          break;

        case "deposit":
          {
            const p = resolveProduct(action);
            setSubtitle("××•×¤×™ ×”×”×¤×§×“×”");
            html += `<div class="field-label">××•×¤×™ ×”×”×¤×§×“×” ×‘${p || "×”××•×¦×¨"}:</div>`;
            html += `<select id="depositType">
                      <option value="">×‘×—×¨...</option>
                      <option value="×œ×œ× ×”×¤×§×“×”" ${action.depositType==="×œ×œ× ×”×¤×§×“×”"?"selected":""}>×œ×œ× ×”×¤×§×“×”</option>
                      <option value="×”×•×¨××ª ×§×‘×¢" ${action.depositType==="×”×•×¨××ª ×§×‘×¢"?"selected":""}>×”×•×¨××ª ×§×‘×¢</option>
                      <option value="×—×“ ×¤×¢××™" ${action.depositType==="×—×“ ×¤×¢××™"?"selected":""}>×—×“ ×¤×¢××™</option>
                      <option value="×’× ×•×’×" ${action.depositType==="×’× ×•×’×"?"selected":""}>×’× ×•×’×</option>
                    </select>`;

            const showMonthly = action.depositType === "×”×•×¨××ª ×§×‘×¢" || action.depositType === "×’× ×•×’×";
            const showOneTime = action.depositType === "×—×“ ×¤×¢××™" || action.depositType === "×’× ×•×’×";

            html += `<input type="number" id="depositMonthly" class="${showMonthly ? "" : "hidden"}"
                    placeholder="×¡×›×•× ×”×•×¨××ª ×§×‘×¢ ×—×•×“×©×™×ª" style="margin-top:6px;" value="${action.depositMonthly || ""}" />`;

            html += `<input type="number" id="depositOneTime" class="${showOneTime ? "" : "hidden"}"
                    placeholder="×¡×›×•× ×”×¤×§×“×” ×—×“ ×¤×¢××™×ª" style="margin-top:6px;" value="${action.depositOneTime || ""}" />`;

            html += `<div class="helper-text">×× ××™×Ÿ ×”×¤×§×“×” â€” ×‘×—×¨ "×œ×œ× ×”×¤×§×“×”".</div>`;
          }
          break;

        case "transferTargetCompany":
          setSubtitle("× ×™×•×“ ×§×•×¤×”");
          html += `<div class="field-label">×œ××™×–×• ×—×‘×¨×” ×ª× ×•×™×“ ×”×§×•×¤×”?</div>`;
          html += createSelect("targetCompanySelect", INVEST_COMPANIES, action.targetCompany);
          html += `<input type="text" id="targetCompanyOther" class="${action.targetCompany === "××—×¨" ? "" : "hidden"}"
                  placeholder="×©× ×—×‘×¨×” (×× '××—×¨')" style="margin-top:6px;" value="${action.targetCompanyOther || ""}" />`;
          break;

        case "accountNumber":
          setSubtitle("×¤×¨×˜×™ ×§×•×¤×”");
          html += `<div class="field-label">××” ××¡×¤×¨ ×”×§×•×¤×”?</div>`;
          html += `<input type="text" id="accountNumberInput" value="${action.accountNumber || ""}" />`;
          break;

        case "keepType":
          setSubtitle("×§×•×¤×” ×§×™×™××ª");
          html += `<div class="field-label">×›××©×¨ ×”×§×•×¤×” × ×©××¨×ª â€“ ××” ×™×§×¨×”?</div>`;
          html += createSelect("keepTypeSelect", ["×œ×œ× ×©×™× ×•×™", "×©×™× ×•×™ ××¡×œ×•×œ ×”×©×§×¢×”", "××™× ×•×™ ×¡×•×›×Ÿ"], action.keepType);
          break;

        case "currentTrack":
          setSubtitle("×©×™× ×•×™ ××¡×œ×•×œ ×”×©×§×¢×”");
          html += `<div class="field-label">××” ××¡×œ×•×œ ×”×”×©×§×¢×” ×”× ×•×›×—×™?</div>`;
          html += createSelect("currentTrackSelect", BASE_TRACKS, action.currentTrack);
          html += `<input type="text" id="currentTrackOther" class="${action.currentTrack === "××—×¨" ? "" : "hidden"}"
                  placeholder="××¡×œ×•×œ ××—×¨ (×× '××—×¨')" style="margin-top:6px;" value="${action.currentTrackOther || ""}" />`;
          break;

        case "newTrack":
          setSubtitle("××¡×œ×•×œ ×”×©×§×¢×” ×¢×ª×™×“×™");
          html += `<div class="field-label">××”×• ××¡×œ×•×œ ×”×”×©×§×¢×” ×”×—×“×©?</div>`;
          html += createSelect("newTrackSelect", BASE_TRACKS, action.newTrack);
          html += `<input type="text" id="newTrackOther" class="${action.newTrack === "××—×¨" ? "" : "hidden"}"
                  placeholder="××¡×œ×•×œ ××—×¨ (×× '××—×¨')" style="margin-top:6px;" value="${action.newTrackOther || ""}" />`;
          break;

        case "trackForOpen":
          setSubtitle("××¡×œ×•×œ ×œ×”×©×§×¢×”");
          html += `<div class="field-label">×‘××™×–×” ××¡×œ×•×œ ×™×•×©×§×¢ ×”×›×¡×£?</div>`;
          html += createSelect("openTrackSelect", BASE_TRACKS, action.openTrack);
          html += `<input type="text" id="openTrackOther" class="${action.openTrack === "××—×¨" ? "" : "hidden"}"
                  placeholder="××¡×œ×•×œ ××—×¨ (×× '××—×¨')" style="margin-top:6px;" value="${action.openTrackOther || ""}" />`;
          break;

        case "managementFee":
          setSubtitle("×“××™ × ×™×”×•×œ");
          html += `<div class="field-label">××”× ×“××™ ×”× ×™×”×•×œ?</div>`;

          {
            const p = resolveProduct(action);
            let mgmtVal = action.managementFee || "";
            if (p === "×§×¨×Ÿ ×¤× ×¡×™×”") {
              html += createSelect("mgmtSelect",
                ["0.1% ××¦×‘×™×¨×” ×•×¢×•×“ 1.5% ××”×¤×§×“×”", "0.15% ××¦×‘×™×¨×” ×•×¢×•×“ 1.5% ××”×¤×§×“×”"],
                mgmtVal
              );
            } else if (["×§×¨×Ÿ ×”×©×ª×œ××•×ª", "×§×•×¤×ª ×’××œ", "×§×•×¤×ª ×’××œ ×œ×”×©×§×¢×”"].includes(p)) {
              html += createSelect("mgmtSelect", ["0.6%", "0.7%", "0.8%"], mgmtVal);
            } else {
              html += `<input type="text" id="mgmtSelect" value="${mgmtVal}" />`;
            }
          }

          html += `<input type="text" id="mgmtOther" class="${action.managementFee === "××—×¨" ? "" : "hidden"}"
                  placeholder="×“××™ × ×™×”×•×œ ××—×¨×™× (×× '××—×¨')" style="margin-top:6px;" value="${action.managementFeeOther || ""}" />`;
          break;

        // ===== ×¤×¨×˜ / ×‘×™×˜×•×— =====
        case "privateCompany":
          setSubtitle("×¤×¨×˜×™ ×”×—×‘×¨×”");
          html += `<div class="field-label">××” ×©× ×”×—×‘×¨×”?</div>`;
          html += createSelect("privateCompanySelect", INSURANCE_COMPANIES, action.privateCompany);
          html += `<input type="text" id="privateCompanyOther" class="${action.privateCompany === "××—×¨" ? "" : "hidden"}"
                  placeholder="×©× ×—×‘×¨×” (×× '××—×¨')" style="margin-top:6px;" value="${action.privateCompanyOther || ""}" />`;
          break;

        case "privateProduct":
          setSubtitle("×¡×•×’ ×‘×™×˜×•×—");
          html += `<div class="field-label">××” ×¡×•×’ ×”×‘×™×˜×•×—?</div>`;
          html += createSelect("privateProductSelect", PRIVATE_PRODUCTS, action.privateProduct);
          html += `<input type="text" id="privateProductOther" class="${action.privateProduct === "××—×¨" ? "" : "hidden"}"
                  placeholder="×¡×•×’ ×‘×™×˜×•×— (×× '××—×¨')" style="margin-top:6px;" value="${action.privateProductOther || ""}" />`;
          break;

        case "privateAction":
          setSubtitle("×¤×¢×•×œ×” ×‘×¤×•×œ×™×¡×”");
          html += `<div class="field-label">××” ×¡×•×’ ×”×¤×¢×•×œ×” ×‘×¤×•×œ×™×¡×”?</div>`;
          html += createSelect("privateActionSelect", PRIVATE_ACTIONS, action.privateAction);
          break;

        case "policyNumber":
          setSubtitle("×¤×¨×˜×™ ×¤×•×œ×™×¡×”");
          html += `<div class="field-label">××” ××¡×¤×¨ ×”×¤×•×œ×™×¡×”?</div>`;
          html += `<input type="text" id="policyNumberInput" value="${action.policyNumber || ""}" />`;
          break;

        case "insuranceSum":
          setSubtitle("×¡×›×•× ×‘×™×˜×•×—");
          html += `<div class="field-label">××”×• ×¡×›×•× ×”×‘×™×˜×•×— (×¤×™×¦×•×™)?</div>`;
          html += `<input type="number" id="insuranceSumInput" value="${action.insuranceSum || ""}" />`;
          break;

        case "newPolicyDetails":
          setSubtitle("×¤×¨×˜×™ ×”×¤×•×œ×™×¡×” ×”×—×“×©×”");
          html += `<div class="field-label">×¡×•×’ ×”×‘×™×˜×•×— ×”×—×“×©:</div>`;
          html += createSelect("newPolicyTypeSelect", PRIVATE_PRODUCTS, action.newPolicyType);
          html += `<input type="text" id="newPolicyTypeOther" class="${action.newPolicyType === "××—×¨" ? "" : "hidden"}"
                  placeholder="×¡×•×’ ×‘×™×˜×•×— (×× '××—×¨')" style="margin-top:6px;" value="${action.newPolicyTypeOther || ""}" />`;

          html += `<div class="field-label" style="margin-top:10px;">×‘××™×–×• ×—×‘×¨×” ×ª×•×¤×§ ×”×¤×•×œ×™×¡×” ×”×—×“×©×”?</div>`;
          html += createSelect("newPolicyCompanySelect", INSURANCE_COMPANIES, action.newPolicyCompany);
          html += `<input type="text" id="newPolicyCompanyOther" class="${action.newPolicyCompany === "××—×¨" ? "" : "hidden"}"
                  placeholder="×©× ×—×‘×¨×” (×× '××—×¨')" style="margin-top:6px;" value="${action.newPolicyCompanyOther || ""}" />`;

          html += `<div class="field-label" style="margin-top:10px;">××” ×”×¤×¨××™×” ×”×—×•×“×©×™×ª?</div>`;
          html += `<input type="number" id="newPolicyPremium" value="${action.newPolicyPremium || ""}" />`;
          break;

        case "reasons":
          setSubtitle("× ×™××•×§×™× ×œ×”××œ×¦×”");
          html += `<div class="field-label">×›×ª×•×‘ × ×™××•×§ ×œ×”××œ×¦×” ×–×•:</div>`;
          html += `<textarea id="reasonInput" placeholder="×œ×“×•×’××”: ×“××™ × ×™×”×•×œ × ××•×›×™× ×™×•×ª×¨, ×ª×©×•××•×ª ×˜×•×‘×•×ª ×™×•×ª×¨ ×•×›×•'">${""}</textarea>`;
          if (action.reasons && action.reasons.length) {
            html += `<div class="field-label" style="margin-top:10px;">× ×™××•×§×™× ×©× ×•×¡×¤×•:</div><ul>`;
            action.reasons.forEach((r, idx) => {
              const letter = action.reasons.length > 1 ? `${HEBREW_LETTERS[idx]}. ` : "";
              html += `<li>${letter}${r}</li>`;
            });
            html += `</ul>`;
          }
          html += `<button type="button" class="btn btn-secondary btn-small" id="addReasonBtn">×”×•×¡×£ × ×™××•×§ × ×•×¡×£</button>`;
          break;

        case "summary":
          setSubtitle("");
          container.innerHTML = "";
          showSummary();
          // ×›×¤×ª×•×¨×™× ×¢×“×™×™×Ÿ ×§×™×™××™× ××‘×œ ×œ× ×¢×•×©×™× ×›×œ×•×
          break;

        default:
          break;
      }

      if (currentStep !== "summary") {
        container.innerHTML = html;
      }

      // ×›×¤×ª×•×¨ ×”×•×¡×¤×ª × ×™××•×§
      const addBtn = document.getElementById("addReasonBtn");
      if (addBtn) {
        addBtn.onclick = () => {
          const txt = getValue("reasonInput");
          if (!txt) return;
          action.reasons = action.reasons || [];
          action.reasons.push(txt);
          document.getElementById("reasonInput").value = "";
          render();
        };
      }

      wireDynamicVisibility();

      // ×œ×”×¡×ª×™×¨/×œ× ×¢×•×œ ×—×–×¨×” ×‘×¦×¢×“ ×”×¨××©×•×Ÿ
      document.getElementById("backBtn").disabled =
        (history.length === 0 && currentStep === "mode");
    }

    function wireDynamicVisibility() {
      const pairs = [
        ["companySelect", "companyOther"],
        ["productSelect", "productOther"],
        ["targetCompanySelect", "targetCompanyOther"],
        ["openTrackSelect", "openTrackOther"],
        ["currentTrackSelect", "currentTrackOther"],
        ["newTrackSelect", "newTrackOther"],
        ["privateCompanySelect", "privateCompanyOther"],
        ["privateProductSelect", "privateProductOther"],
        ["newPolicyTypeSelect", "newPolicyTypeOther"],
        ["newPolicyCompanySelect", "newPolicyCompanyOther"],
        ["mgmtSelect", "mgmtOther"]
      ];

      pairs.forEach(([selId, inputId]) => {
        const sel = document.getElementById(selId);
        const inp = document.getElementById(inputId);
        if (sel && inp) {
          function update() {
            if (sel.value === "××—×¨") inp.classList.remove("hidden");
            else inp.classList.add("hidden");
          }
          sel.addEventListener("change", update);
          update();
        }
      });

      // ××¦×‘ ×ª×¢×¡×•×§×ª×™
      const empSel = document.getElementById("employmentSelect");
      const employer = document.getElementById("employerName");
      if (empSel && employer) {
        function updateEmp() {
          if (empSel.value === "×©×›×™×¨×”") employer.classList.remove("hidden");
          else employer.classList.add("hidden");
        }
        empSel.addEventListener("change", updateEmp);
        updateEmp();
      }

      // ××¡×š ×”×¤×§×“×•×ª: ×¡×›×•××™× ×œ×¤×™ ×¡×•×’
      const dSel = document.getElementById("depositType");
      const dM = document.getElementById("depositMonthly");
      const dO = document.getElementById("depositOneTime");
      if (dSel && dM && dO) {
        function updateDep() {
          const v = dSel.value;
          const showMonthly = v === "×”×•×¨××ª ×§×‘×¢" || v === "×’× ×•×’×";
          const showOne = v === "×—×“ ×¤×¢××™" || v === "×’× ×•×’×";
          if (showMonthly) dM.classList.remove("hidden"); else dM.classList.add("hidden");
          if (showOne) dO.classList.remove("hidden"); else dO.classList.add("hidden");
        }
        dSel.addEventListener("change", updateDep);
        updateDep();
      }
    }

    // =====================
    // ×©××™×¨×ª ×¦×¢×“
    // =====================

    function saveCurrentStep() {
      const a = getCurrentAction();

      switch (currentStep) {
        case "mode": {
          const v = getValue("modeSelect");
          if (!v) { alert("×‘×—×¨ ××¦×‘: ×¡×™×›×•× ×”×“×‘×¨×™× ××• ×”××œ×¦×•×ª."); return false; }
          mode = v;
          return true;
        }

        case "totalActions": {
          const n = parseInt(getValue("actionsCount"), 10);
          if (!n || n < 1) { alert("× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ×¤×¢×•×œ×•×ª ×ª×§×™×Ÿ."); return false; }
          totalActions = n;
          actions.length = totalActions;
          return true;
        }

        case "actionType": {
          const t = getValue("actionTypeSelect");
          if (!t) { alert("× × ×œ×‘×—×•×¨ ×¡×•×’ ×¤×¢×•×œ×”."); return false; }
          a.type = t;
          return true;
        }

        case "company": {
          a.company = getValue("companySelect");
          a.companyOther = getValue("companyOther");
          if (!a.company && !a.companyOther) { alert("× × ×œ×‘×—×•×¨ ×—×‘×¨×” ××• ×œ×›×ª×•×‘ ×©× ×—×‘×¨×”."); return false; }
          return true;
        }

        case "product": {
          a.product = getValue("productSelect");
          a.productOther = getValue("productOther");
          const p = resolveProduct(a);
          if (!p) { alert("× × ×œ×‘×—×•×¨ ×¡×•×’ ××•×¦×¨ ××• ×œ×›×ª×•×‘ ××•×ª×•."); return false; }
          return true;
        }

        case "employment": {
          a.employmentType = getValue("employmentSelect");
          a.employerName = getValue("employerName");

          if (!a.employmentType) { alert("× × ×œ×‘×—×•×¨ ××¦×‘ ×ª×¢×¡×•×§×ª×™."); return false; }
          if (a.employmentType === "×©×›×™×¨×”" && !a.employerName) {
            alert("× × ×œ×¨×©×•× ×©× ××¢×¡×™×§.");
            return false;
          }
          return true;
        }

        case "deposit": {
          a.depositType = getValue("depositType");
          a.depositMonthly = getValue("depositMonthly");
          a.depositOneTime = getValue("depositOneTime");

          if (!a.depositType) { alert("× × ×œ×‘×—×•×¨ ××•×¤×™ ×”×¤×§×“×”."); return false; }

          if ((a.depositType === "×”×•×¨××ª ×§×‘×¢" || a.depositType === "×’× ×•×’×") && !a.depositMonthly) {
            alert("× × ×œ×”×–×™×Ÿ ×¡×›×•× ×”×•×¨××ª ×§×‘×¢.");
            return false;
          }
          if ((a.depositType === "×—×“ ×¤×¢××™" || a.depositType === "×’× ×•×’×") && !a.depositOneTime) {
            alert("× × ×œ×”×–×™×Ÿ ×¡×›×•× ×”×¤×§×“×” ×—×“ ×¤×¢××™×ª.");
            return false;
          }
          return true;
        }

        case "transferTargetCompany": {
          a.targetCompany = getValue("targetCompanySelect");
          a.targetCompanyOther = getValue("targetCompanyOther");
          if (!a.targetCompany && !a.targetCompanyOther) { alert("× × ×œ×‘×—×•×¨ ×—×‘×¨×” ××œ×™×” ×ª× ×•×™×“ ×”×§×•×¤×” ××• ×œ×›×ª×•×‘ ×©× ×—×‘×¨×”."); return false; }
          return true;
        }

        case "accountNumber": {
          a.accountNumber = getValue("accountNumberInput");
          if (!a.accountNumber) { alert("× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ×§×•×¤×”."); return false; }
          return true;
        }

        case "keepType": {
          a.keepType = getValue("keepTypeSelect");
          if (!a.keepType) { alert("× × ×œ×‘×—×•×¨ ××” ×™×§×¨×” ×‘×§×•×¤×”."); return false; }
          return true;
        }

        case "currentTrack": {
          a.currentTrack = getValue("currentTrackSelect");
          a.currentTrackOther = getValue("currentTrackOther");
          if (!a.currentTrack && !a.currentTrackOther) { alert("× × ×œ×‘×—×•×¨ ××¡×œ×•×œ × ×•×›×—×™ ××• ×œ×¨×©×•× ××—×“."); return false; }
          return true;
        }

        case "newTrack": {
          a.newTrack = getValue("newTrackSelect");
          a.newTrackOther = getValue("newTrackOther");
          if (!a.newTrack && !a.newTrackOther) { alert("× × ×œ×‘×—×•×¨ ××¡×œ×•×œ ×—×“×© ××• ×œ×¨×©×•× ××—×“."); return false; }
          return true;
        }

        case "trackForOpen": {
          a.openTrack = getValue("openTrackSelect");
          a.openTrackOther = getValue("openTrackOther");
          if (!a.openTrack && !a.openTrackOther) { alert("× × ×œ×‘×—×•×¨ ××¡×œ×•×œ ×”×©×§×¢×” ××• ×œ×¨×©×•× ××—×“."); return false; }
          return true;
        }

        case "managementFee": {
          a.managementFee = getValue("mgmtSelect");
          a.managementFeeOther = getValue("mgmtOther");
          if (!a.managementFee && !a.managementFeeOther) { alert("× × ×œ×”×–×™×Ÿ ×“××™ × ×™×”×•×œ."); return false; }
          return true;
        }

        case "privateCompany": {
          a.privateCompany = getValue("privateCompanySelect");
          a.privateCompanyOther = getValue("privateCompanyOther");
          if (!a.privateCompany && !a.privateCompanyOther) { alert("× × ×œ×‘×—×•×¨ ×—×‘×¨×” ××• ×œ×¨×©×•× ××—×ª."); return false; }
          return true;
        }

        case "privateProduct": {
          a.privateProduct = getValue("privateProductSelect");
          a.privateProductOther = getValue("privateProductOther");
          if (!a.privateProduct && !a.privateProductOther) { alert("× × ×œ×‘×—×•×¨ ×¡×•×’ ×‘×™×˜×•×— ××• ×œ×¨×©×•× ××—×“."); return false; }
          return true;
        }

        case "privateAction": {
          a.privateAction = getValue("privateActionSelect");
          if (!a.privateAction) { alert("× × ×œ×‘×—×•×¨ ×¡×•×’ ×¤×¢×•×œ×” ×‘×¤×•×œ×™×¡×”."); return false; }
          return true;
        }

        case "policyNumber": {
          a.policyNumber = getValue("policyNumberInput");
          if (!a.policyNumber) { alert("× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ×¤×•×œ×™×¡×”."); return false; }
          return true;
        }

        case "insuranceSum": {
          a.insuranceSum = getValue("insuranceSumInput");
          if (!a.insuranceSum) { alert("× × ×œ×”×–×™×Ÿ ×¡×›×•× ×‘×™×˜×•×—."); return false; }
          return true;
        }

        case "newPolicyDetails": {
          a.newPolicyType = getValue("newPolicyTypeSelect");
          a.newPolicyTypeOther = getValue("newPolicyTypeOther");
          a.newPolicyCompany = getValue("newPolicyCompanySelect");
          a.newPolicyCompanyOther = getValue("newPolicyCompanyOther");
          a.newPolicyPremium = getValue("newPolicyPremium");

          if (!a.newPolicyType && !a.newPolicyTypeOther) { alert("× × ×œ×‘×—×•×¨ ×¡×•×’ ×‘×™×˜×•×— ×—×“×© ××• ×œ×¨×©×•× ××—×“."); return false; }
          if (!a.newPolicyCompany && !a.newPolicyCompanyOther) { alert("× × ×œ×‘×—×•×¨ ×—×‘×¨×” ×—×“×©×” ××• ×œ×¨×©×•× ××—×ª."); return false; }
          if (!a.newPolicyPremium) { alert("× × ×œ×”×–×™×Ÿ ×¤×¨××™×” ×—×•×“×©×™×ª."); return false; }
          return true;
        }

        case "reasons": {
          const txt = getValue("reasonInput");
          if (txt) {
            a.reasons = a.reasons || [];
            a.reasons.push(txt);
          }
          return true;
        }

        case "summary":
          return true;

        default:
          return true;
      }
    }

    // =====================
    // ×—×™×©×•×‘ ×”×¦×¢×“ ×”×‘×
    // =====================

    function computeNextStep() {
      const a = getCurrentAction();

      if (currentStep === "mode") return "totalActions";
      if (currentStep === "totalActions") { currentActionIndex = 0; return "actionType"; }

      if (currentStep === "actionType") {
        return (a.type === "×¤×¨×˜") ? "privateCompany" : "company";
      }

      // ----- ×¤× ×¡×™×•× ×™ / ×”×©×§×¢×•×ª -----
      if (a.type !== "×¤×¨×˜") {
        switch (currentStep) {
          case "company":
            return "product";

          case "product": {
            const p = resolveProduct(a);

            // ××—×¨×™ ×‘×—×™×¨×ª ××•×¦×¨ â€” ×§×•×“× ××¦×‘ ×ª×¢×¡×•×§×ª×™ (×œ××•×¦×¨×™× ×”×¤× ×¡×™×•× ×™×™×)
            if (["×§×¨×Ÿ ×¤× ×¡×™×”", "×§×¨×Ÿ ×”×©×ª×œ××•×ª", "×§×•×¤×ª ×’××œ"].includes(p)) {
              return "employment";
            }

            // ×§×•×¤×ª ×’××œ ×œ×”×©×§×¢×” â€” ××™×Ÿ ×ª×¢×¡×•×§×” ×—×•×‘×”, ×™×©×¨ ×œ××¡×š ×”×¤×§×“×”
            if (p === "×§×•×¤×ª ×’××œ ×œ×”×©×§×¢×”") {
              return "deposit";
            }

            // fallback
            return a.type === "×¤×ª×™×—×ª ×§×•×¤×”" ? "trackForOpen"
              : a.type === "× ×™×•×“" ? "transferTargetCompany"
              : "keepType";
          }

          case "employment": {
            const p = resolveProduct(a);

            // âœ… ×›××Ÿ ×”×ª×™×§×•×Ÿ: ××¡×š ×”×¤×§×“×•×ª ×œ×›×œ ×©×œ×•×©×ª ×”××•×¦×¨×™× ×‘×œ×‘×“
            if (DEPOSIT_PRODUCTS.includes(p)) {
              return "deposit";
            }

            // ××—×¨×ª ×××©×™×›×™× ×¨×’×™×œ
            return a.type === "×¤×ª×™×—×ª ×§×•×¤×”" ? "trackForOpen"
              : a.type === "× ×™×•×“" ? "transferTargetCompany"
              : "keepType";
          }

          case "deposit":
            return a.type === "×¤×ª×™×—×ª ×§×•×¤×”" ? "trackForOpen"
              : a.type === "× ×™×•×“" ? "transferTargetCompany"
              : "keepType";

          case "transferTargetCompany":
            return "accountNumber";

          case "accountNumber":
            if (a.type === "× ×™×•×“") return "trackForOpen";
            if (a.type === "×”×©××¨×”" && a.keepType === "××™× ×•×™ ×¡×•×›×Ÿ") {
              return (mode === MODE_RECOMMENDATION) ? "reasons" : advanceActionOrFinish();
            }
            return "trackForOpen";

          case "keepType":
            if (a.keepType === "×©×™× ×•×™ ××¡×œ×•×œ ×”×©×§×¢×”") return "currentTrack";
            if (a.keepType === "××™× ×•×™ ×¡×•×›×Ÿ") return "accountNumber";
            return (mode === MODE_RECOMMENDATION) ? "reasons" : advanceActionOrFinish();

          case "currentTrack":
            return "newTrack";

          case "newTrack":
            return "managementFee";

          case "trackForOpen":
            return "managementFee";

          case "managementFee":
            return (mode === MODE_RECOMMENDATION) ? "reasons" : advanceActionOrFinish();

          case "reasons":
            return advanceActionOrFinish();

          default:
            return null;
        }
      }

      // ----- ×¤×¨×˜ / ×‘×™×˜×•×— -----
      else {
        const lifeTypes = [
          "×¤×•×œ×™×¡×ª ×—×™×™×",
          "×¤×•×œ×™×¡×ª ×—×™×™× ××©×•×¢×‘×“×ª",
          "×‘×™×˜×•×— ×‘×¨×™××•×ª",
          "×‘×™×˜×•×— ×‘×¨×™××•×ª ×•××—×œ×•×ª ×§×©×•×ª",
          "×‘×™×˜×•×— ××—×œ×•×ª ×§×©×•×ª"
        ];

        switch (currentStep) {
          case "privateCompany":
            return "privateProduct";

          case "privateProduct":
            return "privateAction";

          case "privateAction":
            if (["×‘×™×˜×•×œ", "×”×©××¨×”", "×‘×™×˜×•×œ ×•×”×¤×§×” ×—×“×©×”"].includes(a.privateAction)) return "policyNumber";
            if (a.privateAction === "×”×¤×§×”") {
              if (lifeTypes.includes(a.privateProduct)) return "insuranceSum";
              return "newPolicyDetails";
            }
            if (a.privateAction === "××™× ×•×™ ×¡×•×›×Ÿ") return "policyNumber";
            return null;

          case "policyNumber":
            if (a.privateAction === "×‘×™×˜×•×œ ×•×”×¤×§×” ×—×“×©×”" || a.privateAction === "×”×¤×§×”") {
              if (lifeTypes.includes(a.privateProduct)) return "insuranceSum";
              return "newPolicyDetails";
            }
            return (mode === MODE_RECOMMENDATION) ? "reasons" : advanceActionOrFinish();

          case "insuranceSum":
            return "newPolicyDetails";

          case "newPolicyDetails":
            return (mode === MODE_RECOMMENDATION) ? "reasons" : advanceActionOrFinish();

          case "reasons":
            return advanceActionOrFinish();

          default:
            return null;
        }
      }
    }

    function advanceActionOrFinish() {
      if (currentActionIndex + 1 < totalActions) {
        currentActionIndex++;
        return "actionType";
      }
      return "summary";
    }

    // =====================
    // ×¡×™×›×•× ×¡×•×¤×™
    // =====================

    function showSummary() {
      const box = document.getElementById("summaryBox");
      const copyBtn = document.getElementById("copyBtn");
      const lines = [];

      if (mode === MODE_SUMMARY) {
        lines.push("×‘×”××©×š ×œ×©×™×—×ª× ×•");
        lines.push("×¡×•×›× ×¢×œ ×”×“×‘×¨×™× ×”×‘××™×:");
        lines.push("");
      } else {
        lines.push("×‘×”××©×š ×œ×©×™×—×ª× ×•");
        lines.push("×œ×”×œ×Ÿ ×”×”××œ×¦×•×ª ×©× ×××¨×• ×‘×©×™×—×”:");
        lines.push("");
      }

      actions.forEach((a, idx) => {
        if (!a || !a.type) return;

        let line = `${idx + 1}. `;

        if (a.type !== "×¤×¨×˜") {
          const company = formatCompanyWithOther(a.company, a.companyOther);
          const product = resolveProduct(a);
          let empPart = "";

          if (["×§×¨×Ÿ ×¤× ×¡×™×”", "×§×¨×Ÿ ×”×©×ª×œ××•×ª", "×§×•×¤×ª ×’××œ"].includes(product)) {
            if (a.employmentType === "×©×›×™×¨×”" && a.employerName) empPart = ` ×©×›×™×¨×” ×ª×—×ª ×”××¢×¡×™×§ ${a.employerName}`;
            else if (a.employmentType === "×¢×¦×××™×ª") empPart = " ×¢×¦×××™×ª";
          }

          if (a.type === "×¤×ª×™×—×ª ×§×•×¤×”") {
            let track = (a.openTrack === "××—×¨" ? a.openTrackOther : a.openTrack);
            track = formatTrack(track);

            line += `×¤×ª×™×—×ª ${product}${empPart} ×‘×—×‘×¨×ª ${company} ×›××©×¨ ×”×›×¡×£ ×™×•×©×§×¢ ×‘××¡×œ×•×œ ×”×©×§×¢×” ${track} ×‘×“××™ × ×™×”×•×œ ${
              a.managementFee === "××—×¨" ? a.managementFeeOther : a.managementFee
            }`;

            // âœ… ×”×¤×§×“×•×ª ×¨×§ ×œ××•×¦×¨×™× ×”×¨×œ×•×•× ×˜×™×™×
            if (DEPOSIT_PRODUCTS.includes(product) && a.depositType && a.depositType !== "×œ×œ× ×”×¤×§×“×”") {
              if (a.depositType === "×”×•×¨××ª ×§×‘×¢") line += ` ×¢× ×”×•×¨××ª ×§×‘×¢ ×©×œ ${a.depositMonthly} â‚ª ×‘×—×•×“×©`;
              else if (a.depositType === "×—×“ ×¤×¢××™") line += ` ×¢× ×”×¤×§×“×” ×—×“ ×¤×¢××™×ª ×©×œ ${a.depositOneTime} â‚ª`;
              else if (a.depositType === "×’× ×•×’×") line += ` ×¢× ×”×•×¨××ª ×§×‘×¢ ×©×œ ${a.depositMonthly} â‚ª ×‘×—×•×“×© ×•×”×¤×§×“×” ×—×“ ×¤×¢××™×ª ×©×œ ${a.depositOneTime} â‚ª`;
            }

            line += ".";
          }

          else if (a.type === "× ×™×•×“") {
            const target = formatCompanyWithOther(a.targetCompany, a.targetCompanyOther);
            let track = (a.openTrack === "××—×¨" ? a.openTrackOther : a.openTrack);
            track = formatTrack(track);
            const mgmt = (a.managementFee === "××—×¨" ? a.managementFeeOther : a.managementFee);

            line += `${company} ${product}${empPart} ××¡×¤×¨ ×§×•×¤×” ${a.accountNumber}- ×ª× ×•×™×“ ×œ×—×‘×¨×ª ${target} ×›××©×¨ ×”×›×¡×£ ×™×•×©×§×¢ ×‘××¡×œ×•×œ ×”×©×§×¢×” ${track} ×‘×“××™ × ×™×”×•×œ ${mgmt}.`;
          }

          else if (a.type === "×”×©××¨×”") {
            const mgmt = (a.managementFee === "××—×¨" ? a.managementFeeOther : a.managementFee);

            if (a.keepType === "×œ×œ× ×©×™× ×•×™") {
              line += `${company} ${product}${empPart} ××¡×¤×¨ ×§×•×¤×” ${a.accountNumber}- ×ª×™×©××¨ ×œ×œ× ×©×™× ×•×™ ×‘××•×ª× ×“××™ × ×™×”×•×œ.`;
            } else if (a.keepType === "×©×™× ×•×™ ××¡×œ×•×œ ×”×©×§×¢×”") {
              let cur = (a.currentTrack === "××—×¨" ? a.currentTrackOther : a.currentTrack);
              let n = (a.newTrack === "××—×¨" ? a.newTrackOther : a.newTrack);
              cur = formatTrack(cur); n = formatTrack(n);
              line += `${company} ${product}${empPart} ××¡×¤×¨ ×§×•×¤×” ${a.accountNumber}- ×ª×™×©××¨ ×‘××•×ª×” ×—×‘×¨×” ×›××©×¨ ×™×ª×‘×¦×¢ ×©×™× ×•×™ ××¡×œ×•×œ ×${cur} ×œ${n} ×‘×“××™ × ×™×”×•×œ ${mgmt}.`;
            } else if (a.keepType === "××™× ×•×™ ×¡×•×›×Ÿ") {
              line += `${company} ${product}${empPart} ××¡×¤×¨ ×§×•×¤×” ${a.accountNumber}- ×™×ª×‘×¦×¢ ××™× ×•×™ ×¡×•×›×Ÿ ×‘×§×•×¤×” ×–×•.`;
            }
          }

        } else {
          const company = formatCompanyWithOther(a.privateCompany, a.privateCompanyOther);
          const product = (a.privateProduct === "××—×¨" ? a.privateProductOther : a.privateProduct);

          if (a.privateAction === "×‘×™×˜×•×œ") line += `${product} ×‘×—×‘×¨×ª ${company} ××¡×¤×¨ ×¤×•×œ×™×¡×” ${a.policyNumber}- ×ª×‘×•×˜×œ.`;
          else if (a.privateAction === "×”×©××¨×”") line += `${product} ×‘×—×‘×¨×ª ${company} ××¡×¤×¨ ×¤×•×œ×™×¡×” ${a.policyNumber}- ×ª×™×©××¨ ×œ×œ× ×©×™× ×•×™.`;
          else if (a.privateAction === "××™× ×•×™ ×¡×•×›×Ÿ") line += `${product} ×‘×—×‘×¨×ª ${company} ××¡×¤×¨ ×¤×•×œ×™×¡×” ${a.policyNumber}- ×™×ª×‘×¦×¢ ××™× ×•×™ ×¡×•×›×Ÿ ×‘×¤×•×œ×™×¡×” ×–×•.`;
          else if (a.privateAction === "×”×¤×§×”") {
            const newType = (a.newPolicyType === "××—×¨" ? a.newPolicyTypeOther : (a.newPolicyType || product));
            const newComp = formatCompanyWithOther(a.newPolicyCompany, a.newPolicyCompanyOther);

            let sumPart = "";
            const lifeTypes = [
              "×¤×•×œ×™×¡×ª ×—×™×™×","×¤×•×œ×™×¡×ª ×—×™×™× ××©×•×¢×‘×“×ª","×‘×™×˜×•×— ×‘×¨×™××•×ª","×‘×™×˜×•×— ×‘×¨×™××•×ª ×•××—×œ×•×ª ×§×©×•×ª","×‘×™×˜×•×— ××—×œ×•×ª ×§×©×•×ª"
            ];
            if (lifeTypes.includes(product) && a.insuranceSum) sumPart = ` ×¢× ×¤×™×¦×•×™ ×©×œ ${a.insuranceSum} â‚ª`;

            line += (mode === MODE_RECOMMENDATION)
              ? `×¤×ª×™×—×ª ×¤×•×œ×™×¡×” ×©×œ ${newType}${sumPart} ×‘×—×‘×¨×ª ${newComp} ×‘×¤×¨××™×” ×—×•×“×©×™×ª ×©×œ ${a.newPolicyPremium} â‚ª.`
              : `×ª×•×¤×§ ×¤×•×œ×™×¡×” ×—×“×©×” ×©×œ ${newType}${sumPart} ×‘×—×‘×¨×ª ${newComp} ×‘×¤×¨××™×” ×—×•×“×©×™×ª ×©×œ ${a.newPolicyPremium} â‚ª.`;
          }
          else if (a.privateAction === "×‘×™×˜×•×œ ×•×”×¤×§×” ×—×“×©×”") {
            const newType = (a.newPolicyType === "××—×¨" ? a.newPolicyTypeOther : a.newPolicyType);
            const newComp = formatCompanyWithOther(a.newPolicyCompany, a.newPolicyCompanyOther);

            let sumPart = "";
            const lifeTypes = [
              "×¤×•×œ×™×¡×ª ×—×™×™×","×¤×•×œ×™×¡×ª ×—×™×™× ××©×•×¢×‘×“×ª","×‘×™×˜×•×— ×‘×¨×™××•×ª","×‘×™×˜×•×— ×‘×¨×™××•×ª ×•××—×œ×•×ª ×§×©×•×ª","×‘×™×˜×•×— ××—×œ×•×ª ×§×©×•×ª"
            ];
            if (lifeTypes.includes(product) && a.insuranceSum) sumPart = ` ×¢× ×¤×™×¦×•×™ ×©×œ ${a.insuranceSum} â‚ª`;

            line += `${product} ×‘×—×‘×¨×ª ${company} ××¡×¤×¨ ×¤×•×œ×™×¡×” ${a.policyNumber}- ×¤×•×œ×™×¡×” ×–×• ×ª×ª×‘×˜×œ ×•×‘××§×•× ×–×” ×ª×•×¤×§ ×¤×•×œ×™×¡×ª ${newType}${sumPart} ×‘×—×‘×¨×ª ${newComp} ×‘×¤×¨××™×” ×—×•×“×©×™×ª ×©×œ ${a.newPolicyPremium} â‚ª.`;
          }
        }

        // × ×™××•×§×™×
        if (mode === MODE_RECOMMENDATION && a.reasons && a.reasons.length) {
          line += "\n×œ×”×œ×Ÿ ×”×¡×™×‘×•×ª ×œ×”××œ×¦×” ×–××ª:\n";
          if (a.reasons.length === 1) {
            line += a.reasons[0];
          } else {
            a.reasons.forEach((r, i) => {
              const letter = HEBREW_LETTERS[i] || "";
              line += `${letter}. ${r}\n`;
            });
            line = line.trimEnd();
          }
        }

        lines.push(line);
        lines.push("");
      });

      box.textContent = lines.join("\n").trim();
      box.classList.remove("hidden");
      copyBtn.classList.remove("hidden");
      copyBtn.onclick = () => {
        try {
          navigator.clipboard.writeText(box.textContent || "");
          alert("×”×¡×™×›×•× ×”×•×¢×ª×§ ×œ×œ×•×—");
        } catch (e) {
          alert("×œ× ×”×¦×œ×—×ª×™ ×œ×”×¢×ª×™×§, ×ª×¡××Ÿ ×•×ª×¢×ª×™×§ ×™×“× ×™×ª ğŸ™‚");
        }
      };
    }

    // =====================
    // × ×™×•×•×˜
    // =====================

    document.getElementById("nextBtn").addEventListener("click", () => {
      if (currentStep === "summary") return;
      if (!saveCurrentStep()) return;
      history.push(currentStep);
      const next = computeNextStep();
      if (next) {
        currentStep = next;
        render();
      }
    });

    document.getElementById("backBtn").addEventListener("click", () => {
      if (!history.length) return;
      currentStep = history.pop();
      render();
    });

    // ×”×ª×—×œ×”
    render();
  </script>
</body>
</html>
