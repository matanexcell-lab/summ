<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>סיכום שיחה</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: #f3f4f6;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .app-wrapper {
      width: 100%;
      max-width: 480px;
      padding: 24px 12px 40px;
    }
    .card {
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 8px 30px rgba(15, 23, 42, 0.12);
      padding: 24px 20px 16px;
    }
    h1 {
      margin: 0 0 12px;
      text-align: center;
      font-size: 26px;
      font-weight: 800;
    }
    .subtitle {
      text-align: center;
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 12px;
    }
    .step-indicator {
      text-align: center;
      font-size: 13px;
      color: #4b5563;
      margin-bottom: 8px;
    }
    .question-title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .field-label {
      font-size: 14px;
      margin-bottom: 6px;
      color: #374151;
    }
    select,
    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 10px 11px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 15px;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s;
      background-color: #fff;
    }
    select:focus,
    input:focus,
    textarea:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.6);
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    .buttons-row {
      display: flex;
      gap: 10px;
      margin-top: 14px;
    }
    .btn {
      flex: 1;
      border: none;
      border-radius: 999px;
      padding: 11px 0;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s, transform 0.05s, box-shadow 0.15s;
    }
    .btn-primary {
      background: #2563eb;
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .btn-small {
      flex: 0 0 auto;
      padding-inline: 14px;
      font-size: 13px;
      margin-top: 6px;
    }
    .btn-primary:active,
    .btn-secondary:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    .helper-text {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
    .error-text {
      font-size: 13px;
      color: #b91c1c;
      margin-top: 6px;
    }
    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .chip {
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      color: #374151;
    }
    .summary-box {
      margin-top: 18px;
      background: #111827;
      color: #f9fafb;
      border-radius: 16px;
      padding: 16px 14px;
      white-space: pre-wrap;
      font-size: 14px;
      direction: rtl;
    }
    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .mode-pill {
      font-size: 11px;
      padding: 2px 10px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="app-wrapper">
    <div class="card">
      <div class="top-row">
        <h1>סיכום שיחה</h1>
        <span id="modePill" class="mode-pill hidden"></span>
      </div>
      <div id="subtitle" class="subtitle"></div>
      <div id="stepIndicator" class="step-indicator"></div>
      <div id="formContainer"></div>
      <div class="buttons-row">
        <button id="backBtn" class="btn btn-secondary">חזרה</button>
        <button id="nextBtn" class="btn btn-primary">המשך</button>
      </div>
      <div id="summaryBox" class="summary-box hidden"></div>
      <button id="copyBtn" class="btn btn-secondary btn-small hidden" style="width:100%;margin-top:8px;">
        העתק סיכום
      </button>
    </div>
  </div>

  <script>
    // =====================
    // נתונים קבועים
    // =====================

    const ACTION_TYPES = ["ניוד", "השארה", "פתיחת קופה", "פרט"];

    const INVEST_COMPANIES = [
      "מגדל",
      "כלל",
      "הראל",
      "אלטשולר שחם",
      "ילין לפידות",
      "אנליסט",
      "מיטב",
      "מור",
      "הפניקס",
      "הכשרה",
      "מנורה",
      "איילון",
      "ביטוח ישיר"
    ];

    const INSURANCE_COMPANIES = [
      "מגדל",
      "כלל",
      "הראל",
      "הפניקס",
      "הכשרה",
      "מנורה",
      "איילון",
      "ביטוח ישיר"
    ];

    const PRODUCTS = ["קרן פנסיה", "קרן השתלמות", "קופת גמל", "קופת גמל להשקעה"];

    const PRIVATE_PRODUCTS = [
      "פוליסת חיים",
      "פוליסת חיים משועבדת",
      "פוליסת משכנתא",
      "ביטוח בריאות",
      "ביטוח בריאות ומחלות קשות"
    ];

    const PRIVATE_ACTIONS = [
      "ביטול",
      "השארה",
      "הפקה",
      "מינוי סוכן",
      "ביטול והפקה חדשה"
    ];

    const BASE_TRACKS = [
      "כללי",
      "לבני 50 ומטה",
      "לבני 50-60",
      "לבני 60 ומעלה",
      "מניות",
      "Snp500",
      "משולב סחיר",
      "עוקב מדדים גמיש",
      "מניות סחיר",
      "עוקב מדדי מניות",
      "השלוש הקדוש",
      "חצי חצי אנליסט"
    ];

    const SPECIAL_TRACK_OUTPUT = {
      "השלוש הקדוש": "33% משולב סחיר, 33% מדדי מניות, 34% Snp500",
      "חצי חצי אנליסט": "50% עוקב מדדים גמיש, 50% Snp500"
    };

    const EMPLOYMENT_TYPES = ["שכירה", "עצמאית", "ללא"];

    const MODE_SUMMARY = "סיכום הדברים";
    const MODE_RECOMMENDATION = "המלצות";

    const HEBREW_LETTERS = "אבגדהוזחטיכלמנסעפצקרשת".split("");

    // =====================
    // סטייט גלובלי
    // =====================

    let mode = MODE_SUMMARY;
    let totalActions = 1;
    let currentActionIndex = 0;
    let currentStep = "mode";
    let history = [];

    const actions = [];

    // =====================
    // עזרים
    // =====================

    function getCurrentAction() {
      if (!actions[currentActionIndex]) {
        actions[currentActionIndex] = {
          index: currentActionIndex,
          type: null,
          reasons: []
        };
      }
      return actions[currentActionIndex];
    }

    function setSubtitle(text) {
      document.getElementById("subtitle").textContent = text || "";
    }

    function setStepIndicator() {
      const el = document.getElementById("stepIndicator");
      if (currentStep === "mode" || currentStep === "totalActions") {
        el.textContent = "";
        return;
      }
      el.textContent = `פעולה ${currentActionIndex + 1} מתוך ${totalActions}`;
    }

    function setModePill() {
      const pill = document.getElementById("modePill");
      pill.classList.remove("hidden");
      pill.textContent = mode === MODE_SUMMARY ? "מצב: סיכום דברים" : "מצב: המלצות";
    }

    function createSelect(id, options, value) {
      const htmlOptions = options
        .map(
          (opt) =>
            `<option value="${opt}" ${opt === value ? "selected" : ""}>${opt}</option>`
        )
        .join("");
      return `<select id="${id}">
        <option value="">בחר...</option>
        ${htmlOptions}
        <option value="אחר">אחר...</option>
      </select>`;
    }

    function getValue(id) {
      const el = document.getElementById(id);
      return el ? el.value.trim() : "";
    }

    function setValue(id, value) {
      const el = document.getElementById(id);
      if (el) el.value = value != null ? value : "";
    }

    function showError(msg) {
      return `<div class="error-text">${msg}</div>`;
    }

    function formatTrack(track) {
      if (SPECIAL_TRACK_OUTPUT[track]) {
        return SPECIAL_TRACK_OUTPUT[track];
      }
      return track;
    }

    function formatCompanyWithOther(selected, other) {
      if (selected === "אחר") return other || "";
      return selected || "";
    }

    function bindOtherField(selectId, inputId) {
      const sel = document.getElementById(selectId);
      const inp = document.getElementById(inputId);
      if (!sel || !inp) return;
      function update() {
        if (sel.value === "אחר") {
          inp.style.display = "block";
        } else {
          inp.style.display = "none";
        }
      }
      sel.addEventListener("change", update);
      update();
    }

    function updateEmploymentVisibility() {
      const sel = document.getElementById("employmentSelect");
      const employer = document.getElementById("employerName");
      const selfDep = document.getElementById("selfDeposit");
      if (!sel) return;
      function update() {
        if (employer) {
          employer.style.display = sel.value === "שכירה" ? "block" : "none";
        }
        if (selfDep) {
          selfDep.style.display = sel.value === "עצמאית" ? "block" : "none";
        }
      }
      sel.addEventListener("change", update);
      update();
    }

    function updateKgiDepositVisibility() {
      const sel = document.getElementById("kgiDepositType");
      const monthly = document.getElementById("kgiMonthly");
      const oneTime = document.getElementById("kgiOneTime");
      if (!sel) return;
      function update() {
        if (!monthly || !oneTime) return;
        if (sel.value === "ללא הפקדה" || !sel.value) {
          monthly.style.display = "none";
          oneTime.style.display = "none";
        } else if (sel.value === "הוראת קבע") {
          monthly.style.display = "block";
          oneTime.style.display = "none";
        } else if (sel.value === "חד פעמי") {
          monthly.style.display = "none";
          oneTime.style.display = "block";
        } else if (sel.value === "גם וגם") {
          monthly.style.display = "block";
          oneTime.style.display = "block";
        }
      }
      sel.addEventListener("change", update);
      update();
    }

    function setupDynamicVisibility() {
      // שדות "אחר"
      bindOtherField("companySelect", "companyOther");
      bindOtherField("productSelect", "productOther");
      bindOtherField("currentTrackSelect", "currentTrackOther");
      bindOtherField("newTrackSelect", "newTrackOther");
      bindOtherField("openTrackSelect", "openTrackOther");
      bindOtherField("privateCompanySelect", "privateCompanyOther");
      bindOtherField("privateProductSelect", "privateProductOther");
      bindOtherField("newPolicyTypeSelect", "newPolicyTypeOther");
      bindOtherField("newPolicyCompanySelect", "newPolicyCompanyOther");

      // דמי ניהול "אחר" (רק אם זה select, לא אם זה input רגיל)
      const mgmtSel = document.getElementById("mgmtSelect");
      const mgmtOther = document.getElementById("mgmtOther");
      if (mgmtSel && mgmtOther && mgmtSel.tagName === "SELECT") {
        function updateMgmt() {
          mgmtOther.style.display =
            mgmtSel.value === "אחר" ? "block" : "none";
        }
        mgmtSel.addEventListener("change", updateMgmt);
        updateMgmt();
      } else if (mgmtOther && (!mgmtSel || mgmtSel.tagName !== "SELECT")) {
        // במקרה של אינפוט חופשי – אפשר להשאיר גלוי
        mgmtOther.style.display = "none";
      }

      // מצב תעסוקתי
      updateEmploymentVisibility();

      // קופת גמל להשקעה – הפקדות
      updateKgiDepositVisibility();
    }

    // =====================
    // רנדר לצעד
    // =====================

    function render() {
      const container = document.getElementById("formContainer");
      const summaryBox = document.getElementById("summaryBox");
      const copyBtn = document.getElementById("copyBtn");
      summaryBox.classList.add("hidden");
      summaryBox.textContent = "";
      copyBtn.classList.add("hidden");

      setStepIndicator();
      setModePill();

      let html = "";
      let action = getCurrentAction();

      switch (currentStep) {
        case "mode":
          setSubtitle("");
          html += `<div class="question-title">האם זה סיכום של הדברים או המלצות?</div>`;
          html += createSelect("modeSelect", [MODE_SUMMARY, MODE_RECOMMENDATION], mode);
          if (mode === MODE_RECOMMENDATION) {
            html += `<div class="helper-text">במצב המלצות ניתן להוסיף נימוקים אחרי כל פעולה.</div>`;
          }
          break;

        case "totalActions":
          setSubtitle("");
          html += `<div class="question-title">כמה פעולות אתה רוצה לרשום?</div>`;
          html += `<input type="number" id="actionsCount" min="1" max="20" value="${totalActions}" />`;
          html += `<div class="helper-text">אפשר לשנות אחר כך אם צריך.</div>`;
          break;

        case "actionType":
          setSubtitle("בחר את סוג הפעולה");
          html += `<div class="question-title">מה סוג הפעולה?</div>`;
          html += createSelect("actionTypeSelect", ACTION_TYPES, action.type);
          break;

        // ===== פנסיוני / השקעות =====
        case "company":
          setSubtitle("פרטי החברה והמוצר");
          html += `<div class="field-label">מה שם החברה?</div>`;
          html += createSelect("companySelect", INVEST_COMPANIES, action.company);
          html += `<input type="text" id="companyOther" placeholder="שם החברה (אם נבחר 'אחר')" style="margin-top:6px; display:none;" value="${action.companyOther || ""}" />`;
          break;

        case "product":
          setSubtitle("פרטי החברה והמוצר");
          html += `<div class="field-label">מה סוג המוצר?</div>`;
          html += createSelect("productSelect", PRODUCTS, action.product);
          html += `<input type="text" id="productOther" placeholder="סוג מוצר (אם נבחר 'אחר')" style="margin-top:6px; display:none;" value="${action.productOther || ""}" />`;
          break;

        case "employment":
          setSubtitle("מצב תעסוקתי");
          html += `<div class="field-label">האם הלקוח שכיר, עצמאי או כלום?</div>`;
          html += createSelect("employmentSelect", EMPLOYMENT_TYPES, action.employmentType);
          html += `<input type="text" id="employerName" placeholder="שם המעסיק (אם שכירה)" style="margin-top:6px; display:none;" value="${action.employerName || ""}" />`;
          html += `<input type="number" id="selfDeposit" placeholder="סכום הפקדה (אם עצמאי)" style="margin-top:6px; display:none;" value="${action.selfDeposit || ""}" />`;
          break;

        case "kgiDeposit":
          setSubtitle("אופי ההפקדה");
          html += `<div class="field-label">האם יש הפקדה לקופת גמל להשקעה?</div>`;
          html += createSelect(
            "kgiDepositType",
            ["ללא הפקדה", "הוראת קבע", "חד פעמי", "גם וגם"],
            action.kgiDepositType
          );
          html += `<input type="number" id="kgiMonthly" placeholder="סכום הוראת קבע חודשית" style="margin-top:6px; display:none;" value="${action.kgiMonthly || ""}" />`;
          html += `<input type="number" id="kgiOneTime" placeholder="סכום הפקדה חד פעמית" style="margin-top:6px; display:none;" value="${action.kgiOneTime || ""}" />`;
          break;

        case "transferTargetCompany":
          setSubtitle("ניוד קופה");
          html += `<div class="field-label">לאיזו חברה תנויד הקופה?</div>`;
          html += createSelect(
            "targetCompanySelect",
            INVEST_COMPANIES,
            action.targetCompany
          );
          html += `<input type="text" id="targetCompanyOther" placeholder="שם חברה (אם 'אחר')" style="margin-top:6px; display:none;" value="${action.targetCompanyOther || ""}" />`;
          break;

        case "accountNumber":
          setSubtitle("פרטי קופה");
          html += `<div class="field-label">מה מספר הקופה?</div>`;
          html += `<input type="text" id="accountNumberInput" value="${action.accountNumber || ""}" />`;
          break;

        case "keepType":
          setSubtitle("קופה קיימת");
          html += `<div class="field-label">כאשר הקופה נשארת – מה יקרה?</div>`;
          html += createSelect(
            "keepTypeSelect",
            ["ללא שינוי", "שינוי מסלול השקעה", "מינוי סוכן"],
            action.keepType
          );
          break;

        case "currentTrack":
          setSubtitle("שינוי מסלול השקעה");
          html += `<div class="field-label">מה מסלול ההשקעה הנוכחי?</div>`;
          html += createSelect("currentTrackSelect", BASE_TRACKS, action.currentTrack);
          html += `<input type="text" id="currentTrackOther" placeholder="מסלול אחר (אם 'אחר')" style="margin-top:6px; display:none;" value="${action.currentTrackOther || ""}" />`;
          break;

        case "newTrack":
          setSubtitle("מסלול השקעה עתידי");
          html += `<div class="field-label">מהו מסלול ההשקעה החדש?</div>`;
          html += createSelect("newTrackSelect", BASE_TRACKS, action.newTrack);
          html += `<input type="text" id="newTrackOther" placeholder="מסלול אחר (אם 'אחר')" style="margin-top:6px; display:none;" value="${action.newTrackOther || ""}" />`;
          break;

        case "trackForOpen":
          setSubtitle("מסלול להשקעה");
          html += `<div class="field-label">באיזה מסלול יושקע הכסף?</div>`;
          html += createSelect(
            "openTrackSelect",
            BASE_TRACKS,
            action.openTrack
          );
          html += `<input type="text" id="openTrackOther" placeholder="מסלול אחר (אם 'אחר')" style="margin-top:6px; display:none;" value="${action.openTrackOther || ""}" />`;
          break;

        case "managementFee":
          setSubtitle("דמי ניהול");
          html += `<div class="field-label">מהם דמי הניהול?</div>`;

          if (action.product === "קרן פנסיה") {
            html += createSelect(
              "mgmtSelect",
              [
                "0.1% מצבירה ועוד 1.5% מהפקדה",
                "0.15% מצבירה ועוד 1.5% מהפקדה"
              ],
              action.managementFee
            );
          } else if (
            ["קרן השתלמות", "קופת גמל", "קופת גמל להשקעה"].includes(
              action.product
            )
          ) {
            html += createSelect(
              "mgmtSelect",
              ["0.6%", "0.7%", "0.8%"],
              action.managementFee
            );
          } else {
            html += `<input type="text" id="mgmtSelect" value="${
              action.managementFee || ""
            }" />`;
          }
          html += `<input type="text" id="mgmtOther" placeholder="דמי ניהול אחרים (אם 'אחר')" style="margin-top:6px; display:none;" value="${action.managementFeeOther || ""}" />`;
          break;

        // ===== פרט / ביטוח =====
        case "privateCompany":
          setSubtitle("פרטי החברה");
          html += `<div class="field-label">מה שם החברה?</div>`;
          html += createSelect(
            "privateCompanySelect",
            INSURANCE_COMPANIES,
            action.privateCompany
          );
          html += `<input type="text" id="privateCompanyOther" placeholder="שם חברה (אם 'אחר')" style="margin-top:6px; display:none;" value="${action.privateCompanyOther || ""}" />`;
          break;

        case "privateProduct":
          setSubtitle("סוג ביטוח");
          html += `<div class="field-label">מה סוג הביטוח?</div>`;
          html += createSelect(
            "privateProductSelect",
            PRIVATE_PRODUCTS,
            action.privateProduct
          );
          html += `<input type="text" id="privateProductOther" placeholder="סוג ביטוח (אם 'אחר')" style="margin-top:6px; display:none;" value="${action.privateProductOther || ""}" />`;
          break;

        case "privateAction":
          setSubtitle("פעולה בפוליסה");
          html += `<div class="field-label">מה סוג הפעולה בפוליסה?</div>`;
          html += createSelect(
            "privateActionSelect",
            PRIVATE_ACTIONS,
            action.privateAction
          );
          break;

        case "policyNumber":
          setSubtitle("פרטי פוליסה");
          html += `<div class="field-label">מה מספר הפוליסה?</div>`;
          html += `<input type="text" id="policyNumberInput" value="${action.policyNumber || ""}" />`;
          break;

        case "insuranceSum":
          setSubtitle("סכום ביטוח");
          html += `<div class="field-label">מהו סכום הביטוח (פיצוי)?</div>`;
          html += `<input type="number" id="insuranceSumInput" value="${action.insuranceSum || ""}" />`;
          break;

        case "newPolicyDetails":
          setSubtitle("פרטי הפוליסה החדשה");
          html += `<div class="field-label">סוג הביטוח החדש:</div>`;
          html += createSelect(
            "newPolicyTypeSelect",
            PRIVATE_PRODUCTS,
            action.newPolicyType
          );
          html += `<input type="text" id="newPolicyTypeOther" placeholder="סוג ביטוח (אם 'אחר')" style="margin-top:6px; display:none;" value="${action.newPolicyTypeOther || ""}" />`;
          html += `<div class="field-label" style="margin-top:10px;">באיזו חברה תופק הפוליסה החדשה?</div>`;
          html += createSelect(
            "newPolicyCompanySelect",
            INSURANCE_COMPANIES,
            action.newPolicyCompany
          );
          html += `<input type="text" id="newPolicyCompanyOther" placeholder="שם חברה (אם 'אחר')" style="margin-top:6px; display:none;" value="${action.newPolicyCompanyOther || ""}" />`;
          html += `<div class="field-label" style="margin-top:10px;">מה הפרמיה החודשית?</div>`;
          html += `<input type="number" id="newPolicyPremium" value="${action.newPolicyPremium || ""}" />`;
          break;

        // ===== נימוקים =====
        case "reasons":
          setSubtitle("נימוקים להמלצה");
          html += `<div class="field-label">כתוב נימוק להמלצה זו:</div>`;
          html += `<textarea id="reasonInput" placeholder="לדוגמה: דמי ניהול נמוכים יותר, תשואות טובות יותר וכו'"></textarea>`;
          if (action.reasons && action.reasons.length) {
            html += `<div class="field-label" style="margin-top:10px;">נימוקים שנוספו:</div><ul>`;
            action.reasons.forEach((r, idx) => {
              const letter =
                action.reasons.length > 1 ? `${HEBREW_LETTERS[idx]}. ` : "";
              html += `<li>${letter}${r}</li>`;
            });
            html += `</ul>`;
          }
          html += `<button type="button" class="btn btn-secondary btn-small" id="addReasonBtn">הוסף נימוק נוסף</button>`;
          break;

        default:
          break;
      }

      container.innerHTML = html;

      const addBtn = document.getElementById("addReasonBtn");
      if (addBtn) {
        addBtn.onclick = () => {
          const txt = getValue("reasonInput");
          if (!txt) return;
          action.reasons = action.reasons || [];
          action.reasons.push(txt);
          document.getElementById("reasonInput").value = "";
          render();
        };
      }

      document.getElementById("backBtn").disabled =
        history.length === 0 && (currentStep === "mode");

      // אחרי שיצרנו את ה־HTML – להפעיל הצגות דינמיות
      setupDynamicVisibility();
    }

    // =====================
    // שמירת צעד וחישוב הצעד הבא
    // =====================

    function saveCurrentStep() {
      const a = getCurrentAction();

      switch (currentStep) {
        case "mode": {
          const v = getValue("modeSelect");
          if (!v) {
            alert("בחר מצב: סיכום הדברים או המלצות.");
            return false;
          }
          mode = v;
          return true;
        }
        case "totalActions": {
          let n = parseInt(getValue("actionsCount"), 10);
          if (!n || n < 1) {
            alert("נא להזין מספר פעולות תקין.");
            return false;
          }
          totalActions = n;
          actions.length = totalActions;
          return true;
        }
        case "actionType": {
          const t = getValue("actionTypeSelect");
          if (!t) {
            alert("נא לבחור סוג פעולה.");
            return false;
          }
          a.type = t;
          return true;
        }

        case "company": {
          a.company = getValue("companySelect");
          a.companyOther = getValue("companyOther");
          if (!a.company && !a.companyOther) {
            alert("נא לבחור חברה או לכתוב שם חברה.");
            return false;
          }
          return true;
        }

        case "product": {
          a.product = getValue("productSelect");
          a.productOther = getValue("productOther");
          if (!a.product && !a.productOther) {
            alert("נא לבחור סוג מוצר או לכתוב אותו.");
            return false;
          }
          return true;
        }

        case "employment": {
          a.employmentType = getValue("employmentSelect");
          a.employerName = getValue("employerName");
          a.selfDeposit = getValue("selfDeposit");

          if (a.employmentType === "שכירה" && !a.employerName) {
            alert("נא לרשום שם מעסיק.");
            return false;
          }
          if (a.employmentType === "עצמאית" && !a.selfDeposit) {
            alert("נא לרשום סכום הפקדה.");
            return false;
          }
          return true;
        }

        case "kgiDeposit": {
          a.kgiDepositType = getValue("kgiDepositType");
          a.kgiMonthly = getValue("kgiMonthly");
          a.kgiOneTime = getValue("kgiOneTime");
          if (!a.kgiDepositType) {
            alert("נא לבחור אופי הפקדה.");
            return false;
          }
          if (
            (a.kgiDepositType === "הוראת קבע" ||
              a.kgiDepositType === "גם וגם") &&
            !a.kgiMonthly
          ) {
            alert("נא להזין סכום הוראת קבע.");
            return false;
          }
          if (
            (a.kgiDepositType === "חד פעמי" ||
              a.kgiDepositType === "גם וגם") &&
            !a.kgiOneTime
          ) {
            alert("נא להזין סכום הפקדה חד פעמית.");
            return false;
          }
          return true;
        }

        case "transferTargetCompany": {
          a.targetCompany = getValue("targetCompanySelect");
          a.targetCompanyOther = getValue("targetCompanyOther");
          if (!a.targetCompany && !a.targetCompanyOther) {
            alert("נא לבחור חברה אליה תנויד הקופה או לכתוב שם חברה.");
            return false;
          }
          return true;
        }

        case "accountNumber": {
          a.accountNumber = getValue("accountNumberInput");
          if (!a.accountNumber) {
            alert("נא להזין מספר קופה.");
            return false;
          }
          return true;
        }

        case "keepType": {
          a.keepType = getValue("keepTypeSelect");
          if (!a.keepType) {
            alert("נא לבחור מה יקרה בקופה.");
            return false;
          }
          return true;
        }

        case "currentTrack": {
          a.currentTrack = getValue("currentTrackSelect");
          a.currentTrackOther = getValue("currentTrackOther");
          if (!a.currentTrack && !a.currentTrackOther) {
            alert("נא לבחור מסלול נוכחי או לרשום אחד.");
            return false;
          }
          return true;
        }

        case "newTrack": {
          a.newTrack = getValue("newTrackSelect");
          a.newTrackOther = getValue("newTrackOther");
          if (!a.newTrack && !a.newTrackOther) {
            alert("נא לבחור מסלול חדש או לרשום אחד.");
            return false;
          }
          return true;
        }

        case "trackForOpen": {
          a.openTrack = getValue("openTrackSelect");
          a.openTrackOther = getValue("openTrackOther");
          if (!a.openTrack && !a.openTrackOther) {
            alert("נא לבחור מסלול השקעה או לרשום אחד.");
            return false;
          }
          return true;
        }

        case "managementFee": {
          a.managementFee = getValue("mgmtSelect");
          a.managementFeeOther = getValue("mgmtOther");
          if (!a.managementFee && !a.managementFeeOther) {
            alert("נא להזין דמי ניהול.");
            return false;
          }
          return true;
        }

        case "privateCompany": {
          a.privateCompany = getValue("privateCompanySelect");
          a.privateCompanyOther = getValue("privateCompanyOther");
          if (!a.privateCompany && !a.privateCompanyOther) {
            alert("נא לבחור חברה או לרשום אחת.");
            return false;
          }
          return true;
        }

        case "privateProduct": {
          a.privateProduct = getValue("privateProductSelect");
          a.privateProductOther = getValue("privateProductOther");
          if (!a.privateProduct && !a.privateProductOther) {
            alert("נא לבחור סוג ביטוח או לרשום אחד.");
            return false;
          }
          return true;
        }

        case "privateAction": {
          a.privateAction = getValue("privateActionSelect");
          if (!a.privateAction) {
            alert("נא לבחור סוג פעולה בפוליסה.");
            return false;
          }
          return true;
        }

        case "policyNumber": {
          a.policyNumber = getValue("policyNumberInput");
          if (!a.policyNumber) {
            alert("נא להזין מספר פוליסה.");
            return false;
          }
          return true;
        }

        case "insuranceSum": {
          a.insuranceSum = getValue("insuranceSumInput");
          if (!a.insuranceSum) {
            alert("נא להזין סכום ביטוח.");
            return false;
          }
          return true;
        }

        case "newPolicyDetails": {
          a.newPolicyType = getValue("newPolicyTypeSelect");
          a.newPolicyTypeOther = getValue("newPolicyTypeOther");
          a.newPolicyCompany = getValue("newPolicyCompanySelect");
          a.newPolicyCompanyOther = getValue("newPolicyCompanyOther");
          a.newPolicyPremium = getValue("newPolicyPremium");

          if (!a.newPolicyType && !a.newPolicyTypeOther) {
            alert("נא לבחור סוג ביטוח חדש או לרשום אחד.");
            return false;
          }
          if (!a.newPolicyCompany && !a.newPolicyCompanyOther) {
            alert("נא לבחור חברה חדשה או לרשום אחת.");
            return false;
          }
          if (!a.newPolicyPremium) {
            alert("נא להזין פרמיה חודשית.");
            return false;
          }
          return true;
        }

        case "reasons": {
          const txt = getValue("reasonInput");
          if (txt) {
            a.reasons = a.reasons || [];
            a.reasons.push(txt);
          }
          return true;
        }

        default:
          return true;
      }
    }

    function computeNextStep() {
      const a = getCurrentAction();

      if (currentStep === "mode") return "totalActions";
      if (currentStep === "totalActions") {
        currentActionIndex = 0;
        return "actionType";
      }

      if (currentStep === "actionType") {
        if (a.type === "פרט") {
          return "privateCompany";
        } else {
          return "company";
        }
      }

      if (a.type !== "פרט") {
        switch (currentStep) {
          case "company":
            return "product";

          case "product":
            if (["קרן פנסיה", "קרן השתלמות", "קופת גמל"].includes(a.product)) {
              return "employment";
            }
            if (a.product === "קופת גמל להשקעה") {
              return "kgiDeposit";
            }
            return a.type === "פתיחת קופה"
              ? "trackForOpen"
              : a.type === "ניוד"
              ? "transferTargetCompany"
              : "keepType";

          case "employment":
            if (a.product === "קופת גמל להשקעה") return "kgiDeposit";
            return a.type === "פתיחת קופה"
              ? "trackForOpen"
              : a.type === "ניוד"
              ? "transferTargetCompany"
              : "keepType";

          case "kgiDeposit":
            return a.type === "פתיחת קופה"
              ? "trackForOpen"
              : a.type === "ניוד"
              ? "transferTargetCompany"
              : "keepType";

          case "transferTargetCompany":
            return "accountNumber";

          case "accountNumber":
            return a.type === "ניוד" ? "trackForOpen" : "managementFee";

          case "keepType":
            if (a.keepType === "שינוי מסלול השקעה") return "currentTrack";
            if (a.keepType === "מינוי סוכן") return "accountNumber";
            return "managementFee";

          case "currentTrack":
            return "newTrack";

          case "newTrack":
            return "managementFee";

          case "trackForOpen":
            return "managementFee";

          case "managementFee":
            if (mode === MODE_RECOMMENDATION) {
              return "reasons";
            } else {
              return advanceActionOrFinish();
            }

          case "reasons":
            return advanceActionOrFinish();

          default:
            return null;
        }
      } else {
        switch (currentStep) {
          case "privateCompany":
            return "privateProduct";

          case "privateProduct":
            return "privateAction";

          case "privateAction":
            if (["ביטול", "השארה", "ביטול והפקה חדשה"].includes(a.privateAction)) {
              return "policyNumber";
            }
            if (
              ["פוליסת חיים", "פוליסת חיים משועבדת", "ביטוח בריאות", "ביטוח בריאות ומחלות קשות"].includes(
                a.privateProduct
              )
            ) {
              return a.privateAction === "הפקה" ? "insuranceSum" : "insuranceSum";
            }
            if (a.privateAction === "הפקה") {
              return "newPolicyDetails";
            }
            if (a.privateAction === "מינוי סוכן") {
              return mode === MODE_RECOMMENDATION ? "reasons" : advanceActionOrFinish();
            }
            return mode === MODE_RECOMMENDATION ? "reasons" : advanceActionOrFinish();

          case "policyNumber":
            if (
              ["פוליסת חיים", "פוליסת חיים משועבדת", "ביטוח בריאות", "ביטוח בריאות ומחלות קשות"].includes(
                a.privateProduct
              )
            ) {
              return "insuranceSum";
            }
            if (a.privateAction === "ביטול והפקה חדשה") {
              return "newPolicyDetails";
            }
            return mode === MODE_RECOMMENDATION ? "reasons" : advanceActionOrFinish();

          case "insuranceSum":
            if (a.privateAction === "הפקה" || a.privateAction === "ביטול והפקה חדשה") {
              return "newPolicyDetails";
            }
            return mode === MODE_RECOMMENDATION ? "reasons" : advanceActionOrFinish();

          case "newPolicyDetails":
            return mode === MODE_RECOMMENDATION ? "reasons" : advanceActionOrFinish();

          case "reasons":
            return advanceActionOrFinish();

          default:
            return null;
        }
      }
    }

    function advanceActionOrFinish() {
      if (currentActionIndex + 1 < totalActions) {
        currentActionIndex++;
        return "actionType";
      } else {
        showSummary();
        return null;
      }
    }

    // =====================
    // סיכום סופי
    // =====================

    function showSummary() {
      const box = document.getElementById("summaryBox");
      const copyBtn = document.getElementById("copyBtn");
      const lines = [];

      if (mode === MODE_SUMMARY) {
        lines.push("בהמשך לשיחתנו");
        lines.push("סוכם על הדברים הבאים:");
        lines.push("");
      } else {
        lines.push("בהמשך לשיחתנו");
        lines.push("להלן ההמלצות שנאמרו בשיחה:");
        lines.push("");
      }

      actions.forEach((a, idx) => {
        if (!a || !a.type) return;

        let line = `${idx + 1}. `;

        if (a.type !== "פרט") {
          const company = formatCompanyWithOther(a.company, a.companyOther);
          const product = a.product === "אחר" ? a.productOther : a.product;

          let empPart = "";
          if (["קרן פנסיה", "קרן השתלמות", "קופת גמל"].includes(product)) {
            if (a.employmentType === "שכירה") {
              empPart = a.employerName
                ? ` שכירה תחת המעסיק ${a.employerName}`
                : " שכירה בלבד";
            } else if (a.employmentType === "עצמאית") {
              empPart = a.selfDeposit
                ? ` עצמאית עם הפקדה חודשית של ${a.selfDeposit} ₪`
                : " עצמאית";
            }
          }

          if (a.type === "פתיחת קופה") {
            let track =
              a.openTrack === "אחר" ? a.openTrackOther : a.openTrack;
            track = formatTrack(track);
            line += `פתיחת ${product}${empPart} בחברת ${company} כאשר הכסף יושקע במסלול השקעה ${track} בדמי ניהול ${
              a.managementFee === "אחר" ? a.managementFeeOther : a.managementFee
            }.`;
          } else if (a.type === "ניוד") {
            const target = formatCompanyWithOther(
              a.targetCompany,
              a.targetCompanyOther
            );
            let track =
              a.openTrack === "אחר" ? a.openTrackOther : a.openTrack;
            track = formatTrack(track);
            const mgmt =
              a.managementFee === "אחר"
                ? a.managementFeeOther
                : a.managementFee;
            line += `${company} ${product}${empPart} מספר קופה ${a.accountNumber}- תנויד לחברת ${target} כאשר הכסף יושקע במסלול השקעה ${track} בדמי ניהול ${mgmt}.`;
          } else if (a.type === "השארה") {
            const mgmt =
              a.managementFee === "אחר"
                ? a.managementFeeOther
                : a.managementFee;
            if (a.keepType === "ללא שינוי") {
              line += `${company} ${product}${empPart} מספר קופה ${a.accountNumber}- תישאר ללא שינוי בדמי ניהול ${mgmt}.`;
            } else if (a.keepType === "שינוי מסלול השקעה") {
              let cur =
                a.currentTrack === "אחר"
                  ? a.currentTrackOther
                  : a.currentTrack;
              let n =
                a.newTrack === "אחר" ? a.newTrackOther : a.newTrack;
              cur = formatTrack(cur);
              n = formatTrack(n);
              line += `${company} ${product}${empPart} מספר קופה ${a.accountNumber}- תישאר באותה חברה כאשר יתבצע שינוי מסלול מ${cur} ל${n} בדמי ניהול ${mgmt}.`;
            } else if (a.keepType === "מינוי סוכן") {
              line += `${company} ${product}${empPart} מספר קופה ${a.accountNumber}- יתבצע מינוי סוכן בדמי ניהול ${mgmt}.`;
            }
          }

          if (product === "קופת גמל להשקעה") {
            if (a.kgiDepositType && a.kgiDepositType !== "ללא הפקדה") {
              let dep = "";
              if (a.kgiDepositType === "הוראת קבע") {
                dep = ` עם הוראת קבע של ${a.kgiMonthly} ₪ בחודש`;
              } else if (a.kgiDepositType === "חד פעמי") {
                dep = ` עם הפקדה חד פעמית של ${a.kgiOneTime} ₪`;
              } else if (a.kgiDepositType === "גם וגם") {
                dep = ` עם הוראת קבע של ${a.kgiMonthly} ₪ בחודש והפקדה חד פעמית של ${a.kgiOneTime} ₪`;
              }
              line += dep;
            }
          }
        } else {
          const company = formatCompanyWithOther(
            a.privateCompany,
            a.privateCompanyOther
          );
          const product =
            a.privateProduct === "אחר"
              ? a.privateProductOther
              : a.privateProduct;

          if (a.privateAction === "ביטול") {
            line += `${product} בחברת ${company} מספר פוליסה ${a.policyNumber}- תבוטל.`;
          } else if (a.privateAction === "השארה") {
            line += `${product} בחברת ${company} מספר פוליסה ${a.policyNumber}- תישאר ללא שינוי.`;
          } else if (a.privateAction === "מינוי סוכן") {
            line += `${product} בחברת ${company} מספר פוליסה ${a.policyNumber}- יתבצע מינוי סוכן.`;
          } else if (a.privateAction === "הפקה") {
            let newType =
              a.newPolicyType === "אחר"
                ? a.newPolicyTypeOther
                : a.newPolicyType || product;
            let newComp = formatCompanyWithOther(
              a.newPolicyCompany,
              a.newPolicyCompanyOther
            );
            let sumPart = "";
            if (
              ["פוליסת חיים", "פוליסת חיים משועבדת", "ביטוח בריאות", "ביטוח בריאות ומחלות קשות"].includes(
                product
              ) && a.insuranceSum
            ) {
              sumPart = ` עם פיצוי של ${a.insuranceSum} ₪`;
            }
            if (mode === MODE_RECOMMENDATION) {
              line += `פתיחת פוליסה של ${newType}${sumPart} בחברת ${newComp} בפרמיה חודשית של ${a.newPolicyPremium} ₪.`;
            } else {
              line += `תופק פוליסה חדשה של ${newType}${sumPart} בחברת ${newComp} בפרמיה חודשית של ${a.newPolicyPremium} ₪.`;
            }
          } else if (a.privateAction === "ביטול והפקה חדשה") {
            let newType =
              a.newPolicyType === "אחר"
                ? a.newPolicyTypeOther
                : a.newPolicyType;
            let newComp = formatCompanyWithOther(
              a.newPolicyCompany,
              a.newPolicyCompanyOther
            );
            let sumPart = "";
            if (
              ["פוליסת חיים", "פוליסת חיים משועבדת", "ביטוח בריאות", "ביטוח בריאות ומחלות קשות"].includes(
                product
              ) && a.insuranceSum
            ) {
              sumPart = ` עם פיצוי של ${a.insuranceSum} ₪`;
            }
            line += `${product} בחברת ${company} מספר פוליסה ${a.policyNumber}- פוליסה זו תתבטל ובמקום זה תופק פוליסת ${newType}${sumPart} ב${newComp} בפרמיה חודשית של ${a.newPolicyPremium} ₪.`;
          }
        }

        if (mode === MODE_RECOMMENDATION && a.reasons && a.reasons.length) {
          line += "\nלהלן הסיבות להמלצה זאת:\n";
          if (a.reasons.length === 1) {
            line += a.reasons[0];
          } else {
            a.reasons.forEach((r, i) => {
              const letter = HEBREW_LETTERS[i] || "";
              line += `${letter}. ${r}\n`;
            });
            line = line.trimEnd();
          }
        }

        lines.push(line);
        lines.push("");
      });

      box.textContent = lines.join("\n").trim();
      box.classList.remove("hidden");
      copyBtn.classList.remove("hidden");
    }

    // =====================
    // ניווט + העתקה
    // =====================

    document.getElementById("nextBtn").addEventListener("click", () => {
      if (!saveCurrentStep()) return;
      history.push(currentStep);
      const next = computeNextStep();
      if (next) {
        currentStep = next;
        render();
      }
    });

    document.getElementById("backBtn").addEventListener("click", () => {
      if (!history.length) return;
      currentStep = history.pop();
      render();
    });

    document.getElementById("copyBtn").addEventListener("click", () => {
      const box = document.getElementById("summaryBox");
      const text = box.textContent;
      if (!text) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(() => {
            alert("הסיכום הועתק ללוח.");
          })
          .catch(() => {
            alert("לא הצלחתי להעתיק. ייתכן שהדפדפן חוסם.");
          });
      } else {
        alert("העתקה אוטומטית אינה נתמכת בדפדפן זה.");
      }
    });

    // התחלה
    render();
  </script>
</body>
</html>