<script>

  // =====================
  // קבועים (נשארו זהים)
  // =====================

  const ACTION_TYPES = ["ניוד", "השארה", "פתיחת קופה", "פרט"];

  const INVEST_COMPANIES = [
    "מגדל","כלל","הראל","אלטשולר שחם","ילין לפידות","אנליסט","מיטב","מור","הפניקס","הכשרה","מנורה","איילון","ביטוח ישיר"
  ];

  const INSURANCE_COMPANIES = [
    "מגדל","כלל","הראל","הפניקס","הכשרה","מנורה","איילון","ביטוח ישיר"
  ];

  const PRODUCTS = ["קרן פנסיה","קרן השתלמות","קופת גמל","קופת גמל להשקעה"];

  const PRIVATE_PRODUCTS = [
    "פוליסת חיים",
    "פוליסת חיים משועבדת",
    "פוליסת משכנתא",
    "ביטוח בריאות",
    "ביטוח בריאות ומחלות קשות",
    "ביטוח מחלות קשות"
  ];

  const PRIVATE_ACTIONS = [
    "ביטול",
    "השארה",
    "הפקה",
    "מינוי סוכן",
    "ביטול והפקה חדשה"
  ];

  const BASE_TRACKS = [
    "כללי","לבני 50 ומטה","לבני 50-60","לבני 60 ומעלה",
    "מניות","Snp500","משולב סחיר","עוקב מדדים גמיש",
    "מניות סחיר","עוקב מדדי מניות","השלוש הקדוש","חצי חצי אנליסט"
  ];

  const SPECIAL_TRACK_OUTPUT = {
    "השלוש הקדוש": "33% משולב סחיר, 33% מדדי מניות, 34% Snp500",
    "חצי חצי אנליסט": "50% עוקב מדדים גמיש, 50% Snp500"
  };

  const EMPLOYMENT_TYPES = ["שכירה","עצמאית","ללא"];

  const MODE_SUMMARY = "סיכום הדברים";
  const MODE_RECOMMENDATION = "המלצות";

  const HEBREW_LETTERS = "אבגדהוזחטיכלמנסעפצקרשת".split("");

  // =====================
  // סטייט
  // =====================

  let mode = MODE_SUMMARY;
  let totalActions = 1;
  let currentActionIndex = 0;
  let currentStep = "mode";
  let history = [];
  const actions = [];

  // =====================
  // AUTO FLOW ⭐
  // =====================

  function autoAdvanceIfReady() {

    const selects = document.querySelectorAll("#formContainer select");

    if (!selects.length) return;

    let allFilled = true;

    selects.forEach(sel => {
      if (!sel.value) allFilled = false;
    });

    if (!allFilled) return;

    // delay קטן כדי למנוע כפילות events
    setTimeout(() => {
      document.getElementById("nextBtn").click();
    }, 200);
  }

  // =====================
  // Helpers
  // =====================

  function getCurrentAction() {
    if (!actions[currentActionIndex]) {
      actions[currentActionIndex] = {
        index: currentActionIndex,
        type: null,
        reasons: []
      };
    }
    return actions[currentActionIndex];
  }

  function setSubtitle(text) {
    document.getElementById("subtitle").textContent = text || "";
  }

  function setStepIndicator() {
    const el = document.getElementById("stepIndicator");
    if (currentStep === "mode" || currentStep === "totalActions") {
      el.textContent = "";
      return;
    }
    el.textContent = `פעולה ${currentActionIndex + 1} מתוך ${totalActions}`;
  }

  function setModePill() {
    const pill = document.getElementById("modePill");
    pill.textContent = mode === MODE_SUMMARY ? "מצב: סיכום דברים" : "מצב: המלצות";
  }

  function createSelect(id, options, value) {
    const htmlOptions = options.map(opt =>
      `<option value="${opt}" ${opt === value ? "selected" : ""}>${opt}</option>`
    ).join("");

    return `<select id="${id}">
      <option value="">בחר...</option>
      ${htmlOptions}
      <option value="אחר" ${value === "אחר" ? "selected" : ""}>אחר...</option>
    </select>`;
  }

  function getValue(id) {
    const el = document.getElementById(id);
    return el ? (el.value || "").trim() : "";
  }

  function resolveProduct(a) {
    return (a.product === "אחר" ? (a.productOther || "") : (a.product || "")).trim();
  }

  function formatTrack(track) {
    if (SPECIAL_TRACK_OUTPUT[track]) return SPECIAL_TRACK_OUTPUT[track];
    return track;
  }

  function formatCompanyWithOther(selected, other) {
    if (selected === "אחר") return (other || "").trim();
    return (selected || "").trim();
  }

  function shouldAskDeposit(a) {

    const p = resolveProduct(a);

    if (p === "קופת גמל להשקעה") return true;

    if (a.employmentType === "עצמאית" &&
        ["קרן פנסיה","קרן השתלמות","קופת גמל"].includes(p)) {
      return true;
    }

    return false;
  }

  function shouldShowEmployment(a) {
    const p = resolveProduct(a);
    return ["קרן פנסיה","קרן השתלמות","קופת גמל"].includes(p);
  }

  // =====================
  // render
  // =====================

  function render() {

    const container = document.getElementById("formContainer");

    setModePill();
    setStepIndicator();

    const a = getCurrentAction();
    let html = "";

    // ⚠️ כל ה-render שלך נשאר בדיוק כמו שהיה
    // (לא משנה כלום פה)

    // ... כל הקוד render שלך 그대로 ...

    container.innerHTML = html;

    wireDynamicVisibility();
  }

  // =====================
  // visibility + AUTO FLOW hookup ⭐
  // =====================

  function wireDynamicVisibility() {

    // כל הקוד שלך נשאר

    // AUTO FLOW HOOK
    document.querySelectorAll("#formContainer select").forEach(sel => {
      sel.addEventListener("change", autoAdvanceIfReady);
    });
  }

  // =====================
  // navigation (נשאר אותו דבר)
  // =====================

  document.getElementById("nextBtn").addEventListener("click", () => {

    if (!saveCurrentStep()) return;

    history.push(currentStep);

    const next = computeNextStep();

    if (next) {
      currentStep = next;
      render();
    }
  });

  document.getElementById("backBtn").addEventListener("click", () => {

    if (!history.length) return;

    currentStep = history.pop();

    render();
  });

  render();

</script>
