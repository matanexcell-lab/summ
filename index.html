from kivy.config import Config
Config.set('kivy', 'keyboard_mode', 'systemanddock')

from kivy.app import App
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.anchorlayout import AnchorLayout
from kivy.uix.label import Label
from kivy.uix.textinput import TextInput
from kivy.uix.button import Button
from kivy.core.text import LabelBase
from kivy.core.clipboard import Clipboard
from kivy.clock import Clock
from kivy.uix.scrollview import ScrollView
from kivy.uix.popup import Popup

import os, re

# ---------- RTL helper ----------
PAIR_MAP = str.maketrans("()[]{}<>«»‹›", ")(][}{><»«›‹")

def rtl_visual(s: str) -> str:
    if not s:
        return ""
    out = []
    for line in s.split("\n"):
        if any('\u0590' <= ch <= '\u05FF' for ch in line):
            # RTL reverse but keep numbers correct
            acc = ""
            token = ""
            for ch in line:
                if ch.isdigit() or ch == ":":
                    token += ch
                else:
                    if token:
                        acc = token + acc
                        token = ""
                    acc = ch.translate(PAIR_MAP) + acc
            if token:
                acc = token + acc
            out.append(acc)
        else:
            out.append(line)
    return "\n".join(out)


# ---------- Font ----------
try:
    BASE_DIR = os.path.dirname(os.path.abspath(__file__))
except NameError:
    BASE_DIR = os.getcwd()

FONTS_DIR = os.path.join(BASE_DIR, "static")
font_path = os.path.join(FONTS_DIR, "NotoSansHebrew-Regular.ttf")

if os.path.exists(font_path):
    LabelBase.register(name="HebrewFont", fn_regular=font_path)
    FONT_NAME = "HebrewFont"
else:
    FONT_NAME = "Roboto"


# ---------- שאלות ----------
Q_BASE = [
    "האם היה 10 שעונים מעוררים עד 10-",
    "בקבוק מים ליד המיטה-",
    "האם היה תכנון של היום עם תזכורות-",
    "מתי הלכת לישון אתמול-",
    "קריאת הגנות ופרסים-",
    "האם היה עבודה אחרי 11:30 בלילה-",
    "קריאה ביומן בבוקר-",
    "מתי קמת-",
    "תיעוד הלילה וניתוחו-",
    "כתיבה עצמית בבוקר (10 דקות עם הקפה)-",
    "סרטון מוטביציה בבוקר-",
    "משקל ששקלת בבוקר-",
    "כדור-",
    "ויטמין D-",
    "האם היה טלפון/טלווזיה בלילה-",
    "זמן טלפון בבוקר-",
    "קריאה באמצע היום-",
    "לימוד תורה-",
    "מה למדת היום (עשרה דברים)-",
    "כושר 16:00 דקות-",
    "מטלות-",
    "לימוד אנגלית-",
    "הכתבה 20 דקות-",
    "עשיית דברים-",
    "דיבור עם חברים 20 דקות-",
    "רימונים-",
    "כדור-",
    "חטא-",
    "אכילת מתוק-",
    "שתית קפה-",
    "אכילת לחם-",
    "כמה אכלת סלט ירקות-",
    "סיג-",
    "אוכל לפי תפריט-",
    "מה אכלת היום-",
    "כמות גרם חלבון-",
    "כדור-",
    "כמות מים-",
    "עשיית משימות היה-",
    "בזבוזים של אוכל-",
    "כמות זמן שהיית בטלפון ובטלווזיה-",
    "זמן שהיית בפעילות-",
    "תיעוד של היום וניתוחו-",
    "מתי רשמת את סיכום היום-",
]

# ---------- כותרות המקטעים ----------
SECTIONS_ORDER = [
    ("דברים צריך לכתוב בלילה שלפני", [0,1,2,3,4,5]),
    ("דברים שצריך לכתוב בבוקר",      [6,7,8,9,10,11,12,13,14,15]),
    ("דברים שצריכים לכתוב בזמן שהם קורים", [16]),
    ("מטלות",                         [17,18,19,20,21,22,23,24,25,26]),
    ("ארבע העייפות",                  [27,28,29]),
    ("דברים שצריכים להיכתב בערב",    [30,31,32,33,34,35,36,37,38,39,40,41,42,43]),
]
# ---------- מטרות שבועיות ----------
Q_WEEKLY = [
    "מטרה לסוף השבוע- מטרה לסוף שבוע 7 היה היה",
    "מטרה לסוף השבוע- 5 היה (מטרה יומית- היה)",
    "מטרה לסוף השבוע- 5 היה (מטרה יומית- היה)",
    "מטרה לסוף שבוע ויומי- 25:00",
    "מטרה לסוף השבוע- 5 היה (מטרה יומית- היה)",
    "מטרה לסוף השבוע 5 לא היה (מטרה יומית- לא היה)",
    "מטרה לסוף השבוע- 5 היה (מטרה יומית- היה)",
    "מטרה לסוף השבוע ממוצע- 09:30 (מטרה יומית: מתחת ל09:30)",
    "מטרה לסוף השבוע- ממוצע של 1.5 (מטרה יומית 1 או מתחת)",
    "מטרה לסוף השבוע- 5 היה (מטרה יומית- היה)",
    "מטרה לסוף השבוע- 3 פעמים (מטרה יומית היה)",
    "מטרה לסוף השבוע- 3 פעמים (מטרה יומית היה)",
    "מטרה לסוף השבוע- 14 (מטרה יומית- היה)",
    "מטרה לסוף השבוע- 7 פעמים היה (מטרה יומית- היה)",
    "מטרה לסוף השבוע- 3 היה או מתחת (מטרה יומית- לא היה)",
    "מטרה לסוף השבוע ממוצע- 00:20 (מטרה יומית 00:20 או מתחת)",
    "מטרה לסוף השבוע- 7 פעמים היה (מטרה יומית היה)",
    "מטרה לסוף השבוע- 7 פעמים היה (מטרה יומית היה)",
    "מטרה לסוף השבוע- 7 פעמים היה (מטרה יומית היה)",
    "מטרה לסוף השבוע- 3 פעמים היה (מטרה יומית היה)",
    "מטרה לסוף השבוע- 2 היה (מטרה יומית: היה)",
    "מטרה לסוף השבוע- 7 פעמים היה (מטרה יומית היה)",
    "מטרה לסוף השבוע- 7 פעמים היה (מטרה יומית היה)",
    "מטרה לסוף השבוע- 3 פעמים היה (מטרה יומית היה)",
    "מטרה לסוף השבוע- 3 פעמים היה (מטרה יומית- היה)",
    "מטרה לסוף השבוע- 3 פעמים היה (מטרה יומית: היה)",
    "מטרה לסוף השבוע- 7 היה (מטרה יומית- היה)",
    "מטרה לסוף השבוע ממוצע- 0.42 (מטרה יומית- לא היה אלא אם זה במטרת עשיית דברים)",
    "מטרה לסוף השבוע ממוצע- 0.42 (מטרה יומית- לא היה)",
    "מטרה לסוף השבוע ממוצע- 3 (מטרה יומית: מתחת ל3)",
    "מטרה לסוף השבוע ממוצע- 0.42 (מטרה יומית- לא היה)",
    "מטרה לסוף השבוע ממוצע- 2 (מטרה יומית- 2)",
    "מטרה לסוף השבוע ממוצע- 1 (מטרה יומית 1 או מתחת)",
    "מטרה לסוף השבוע- 55 (מטרה יומית- 50)",
    "מטרה לסוף השבוע- 55 (מטרה יומית- 50)",
    "מטרה לסוף השבוע- 55 (מטרה יומית- 50)",
    "מטרה לסוף השבוע- 14 (מטרה יומית- היה)",
    "מטרה לסוף השבוע- 1700 מדוד (מטרה יומית- 1700)",
    "מטרה לסוף השבוע ממוצע- 20 (מטרה יומית- מתחת ל20)",
    "מטרה לסוף השבוע- 01:30 (מטרה יומית- מתחת ל01:30)",
    "מטרה לסוף השבוע ממוצע- 07:30 (מטרה יומית- 07:30)",
    "מטרה לסוף שבוע- ממוצע של 0.6 היה (מטרה יומית- היה)",
    "מטרה לסוף השבוע ממוצע- 24:00 (מטרה יומית- מתחת ל24:00)",
    "מטרה לסוף השבוע ממוצע- 24:00 (מטרה יומית- מתחת ל24:00)",
]

# ---------- מטרות יומיות ----------
Q_DAILY = [
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – מתחת ל-25:00",
    "מטרה יומית – היה",
    "מטרה יומית – לא היה",
    "מטרה יומית – היה",
    "מטרה יומית – מתחת ל-09:30",
    "מטרה יומית – 1 או פחות",
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – יש ערך",
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – לא היה",
    "מטרה יומית – 00:20 או פחות",
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – יש ערך",
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – לא היה",
    "מטרה יומית – לא היה",
    "מטרה יומית – 2 או פחות",
    "מטרה יומית – לא היה",
    "מטרה יומית – 2 או יותר",
    "מטרה יומית – 1 או פחות",
    "מטרה יומית – היה",
    "מטרה יומית – יש ערך",
    "מטרה יומית – 55 או יותר",
    "מטרה יומית – היה",
    "מטרה יומית – 1500 או יותר",
    "מטרה יומית – היה",
    "מטרה יומית – 20 או פחות",
    "מטרה יומית – 01:30 או פחות",
    "מטרה יומית – 07:30 או יותר",
    "מטרה יומית – היה",
    "מטרה יומית – 24:00 או פחות",
]

# ---------- כללי בדיקה ----------
GOAL_RULES = [
    ('bool', True),
    ('bool', True),
    ('bool', True),
    ('time_max', "25:00"),
    ('bool', True),
    ('bool', False),
    ('bool', True),
    ('time_max', "09:30"),
    ('num_max', 1.0),
    ('bool', True),
    ('bool', True),
    ('nonempty', None),
    ('bool', True),
    ('bool', True),
    ('bool', False),
    ('time_max', "00:20"),
    ('bool', True),
    ('bool', True),
    ('nonempty', None),
    ('bool', True),
    ('bool', True),
    ('bool', True),
    ('bool', True),
    ('bool', True),
    ('bool', True),
    ('bool', True),
    ('bool', True),
    ('bool', False),
    ('bool', False),
    ('num_max', 2.0),
    ('bool', False),
    ('num_min', 2.0),
    ('num_max', 1.0),
    ('bool', True),
    ('nonempty', None),
    ('num_min', 55.0),
    ('bool', True),
    ('num_min', 1500.0),
    ('bool', True),
    ('num_max', 20.0),
    ('time_max', "01:30"),
    ('time_min', "07:30"),
    ('bool', True),
    ('time_max', "24:00"),
]

INTRO_TEXT = (
    "כל דבר שאתה עושה הופך לנכס!\n"
    "כל דבר שאתה לא עושה הופך להתחייבות!\n"
    "השעה 20 תבוא בכל מקרה והשאלה היא האם יהיה לך דברים טובים לכתוב!\n"
)

# ------------------- פונקציות עזר -------------------

def parse_time_to_minutes(s: str):
    if not s:
        return None
    m = re.search(r'(\d{1,2}):(\d{2})', s)
    if not m:
        return None
    return int(m.group(1)) * 60 + int(m.group(2))

def extract_number(s: str):
    if not s:
        return None
    m = re.search(r'(\d+(?:\.\d+)?)', s.replace(",", "."))
    return float(m.group(1)) if m else None

def normalize_bool_answer(s: str):
    if not s:
        return None
    if "לא היה" in s:
        return False
    if "היה" in s:
        return True
    return None

def goal_met(i, a):
    rule, param = GOAL_RULES[i]
    a = (a or "").strip()

    if rule == 'bool':
        v = normalize_bool_answer(a)
        return v is not None and v == param

    if rule == 'time_max':
        t = parse_time_to_minutes(param)
        g = parse_time_to_minutes(a)
        return g is not None and g <= t

    if rule == 'time_min':
        t = parse_time_to_minutes(param)
        g = parse_time_to_minutes(a)
        return g is not None and g >= t

    if rule == 'num_max':
        g = extract_number(a)
        return g is not None and g <= param

    if rule == 'num_min':
        g = extract_number(a)
        return g is not None and g >= param

    if rule == 'nonempty':
        return len(a) > 0

    return False


# --------------------------------------------------
#                האפליקציה
# --------------------------------------------------

class HebrewApp(App):

    def build(self):
        self.answers = {}
        self.current_index = 0
        self.root_anchor = AnchorLayout(anchor_y="top")
        return self.build_opening()

    # ------------------ מסך פתיחה ------------------
    def build_opening(self):
        layout = BoxLayout(orientation="vertical", padding=20, spacing=12,
                           size_hint=(1, None), height=520)

        layout.add_widget(Label(
            text=rtl_visual("הדבק כאן את הטקסט שלך (לא חובה):"),
            font_name=FONT_NAME, font_size=24,
            halign="center", valign="middle",
            size_hint=(1, None), height=40
        ))

        self.paste_box = TextInput(
            hint_text=rtl_visual("הדבקה כאן..."),
            font_name=FONT_NAME, font_size=18,
            multiline=True,
            halign="right",
            size_hint=(1, None), height=360
        )
        layout.add_widget(self.paste_box)

        start_btn = Button(
            text=rtl_visual("התחל שאלון"),
            font_name=FONT_NAME,
            size_hint=(1, None), height=56
        )
        start_btn.bind(on_press=self.start_questionnaire)
        layout.add_widget(start_btn)

        self.root_anchor.add_widget(layout)
        return self.root_anchor
        # ---------------------------------
    def parse_pasted(self, raw):
        if not raw:
            return
        lines = [l.strip() for l in raw.splitlines() if l.strip()]
        for i, base in enumerate(Q_BASE):
            for line in lines:
                if base in line:
                    after = line.split(base, 1)[1].strip()
                    if after:
                        self.answers[i] = after
                    break

    # ---------------------------------
    def start_questionnaire(self, *args):
        try:
            self.parse_pasted(self.paste_box.text)
        except:
            pass

        self.root_anchor.clear_widgets()
        anchor = AnchorLayout(anchor_y="top")

        self.container = BoxLayout(
            orientation="vertical",
            padding=20,
            spacing=15,
            size_hint=(1, None),
            height=600,
            pos_hint={"top": 1}
        )

        anchor.add_widget(self.container)
        self.root_anchor.add_widget(anchor)

        self.build_question(0)

    # ---------------------------------
    def build_question(self, idx):
        self.container.clear_widgets()
        self.current_index = idx

        # ------------------------- כותרת המקטע -------------------------
        section_name = None
        for title, indices in SECTIONS_ORDER:
            if idx in indices:
                section_name = title
                break

        if section_name:
            self.container.add_widget(Label(
                text=rtl_visual(section_name),
                font_name=FONT_NAME,
                font_size=26,
                size_hint=(1, None),
                height=48,
                halign="center",
                valign="middle"
            ))

        # ------------------------- השאלה -------------------------
        self.container.add_widget(Label(
            text=rtl_visual(f"{idx+1}. {Q_BASE[idx]}"),
            font_name=FONT_NAME,
            font_size=26,
            size_hint=(1, None),
            height=60
        ))

        # -------- מטרות --------
        self.container.add_widget(Label(
            text=rtl_visual(Q_WEEKLY[idx]),
            font_name=FONT_NAME, font_size=18,
            size_hint=(1, None), height=32
        ))

        self.container.add_widget(Label(
            text=rtl_visual(Q_DAILY[idx]),
            font_name=FONT_NAME, font_size=18,
            size_hint=(1, None), height=32
        ))

        # -------- הצגת תשובה חיה --------
        self.answer_display = Label(
            text=rtl_visual(self.answers.get(idx, "")),
            font_name=FONT_NAME, font_size=20,
            size_hint=(1, None), height=40
        )
        self.container.add_widget(self.answer_display)

        # -------- שדה הקלדה --------
        self.text_input = TextInput(
            text=self.answers.get(idx, ""),
            font_name=FONT_NAME,
            font_size=20,
            multiline=False,
            halign="right",
            size_hint=(1, None),
            height=56
        )
        self.text_input.bind(text=self.update_answer_display)
        self.text_input.bind(on_text_validate=self.next_question)
        self.container.add_widget(self.text_input)

        # פוקוס חזרה לקלדה
        Clock.schedule_once(lambda dt: setattr(self.text_input, "focus", True), 0.1)

        # -------- כפתורי היה/לא היה --------
        row_yesno = BoxLayout(size_hint=(1, None), height=60, spacing=20)
        btn_yes = Button(text=rtl_visual("היה"), font_name=FONT_NAME)
        btn_no = Button(text=rtl_visual("לא היה"), font_name=FONT_NAME)

        btn_yes.bind(on_press=lambda *a: self.set_answer_and_next("היה"))
        btn_no.bind(on_press=lambda *a: self.set_answer_and_next("לא היה"))

        row_yesno.add_widget(btn_yes)
        row_yesno.add_widget(btn_no)
        self.container.add_widget(row_yesno)

        # -------- מעבר למקטע --------
        btn_section = Button(
            text=rtl_visual("מעבר למקטע אחר"),
            font_name=FONT_NAME,
            size_hint=(1, None), height=60
        )
        btn_section.bind(on_press=self.open_section_menu)
        self.container.add_widget(btn_section)

        # -------- ניווט --------
        nav_row = BoxLayout(size_hint=(1, None), height=90, spacing=18)

        btn_prev = Button(
            text=rtl_visual("שאלה קודמת"),
            font_name=FONT_NAME, size_hint=(1, None), height=80
        )
        btn_prev.bind(on_press=self.prev_question)
        nav_row.add_widget(btn_prev)

        btn_next = Button(
            text=rtl_visual("לשאלה הבאה"),
            font_name=FONT_NAME, size_hint=(1, None), height=80
        )
        btn_next.bind(on_press=self.next_question)
        nav_row.add_widget(btn_next)

        btn_finish = Button(
            text=rtl_visual("סיום השאלון"),
            font_name=FONT_NAME, size_hint=(1, None), height=80
        )
        btn_finish.bind(on_press=self.show_summary)
        nav_row.add_widget(btn_finish)

        self.container.add_widget(nav_row)

    # ---------------------------------
    #       בחירת מקטעים
    # ---------------------------------
    def open_section_menu(self, *args):
        layout = BoxLayout(orientation="vertical", spacing=12, padding=12)

        for title, indices in SECTIONS_ORDER:
            btn = Button(
                text=rtl_visual(title),
                font_name=FONT_NAME,
                size_hint=(1, None),
                height=60
            )
            btn.bind(on_press=lambda inst, q=indices[0]: self.jump_to_section(q))
            layout.add_widget(btn)

        popup = Popup(
            title=rtl_visual("בחר מקטע"),
            size_hint=(0.8, 0.8),
            content=layout
        )
        self._section_popup = popup
        popup.open()

    def jump_to_section(self, q_index):
        self._section_popup.dismiss()
        self.build_question(q_index)

    # ---------------------------------
    def prev_question(self, *args):
        if self.current_index > 0:
            self.answers[self.current_index] = self.text_input.text.strip()
            self.build_question(self.current_index - 1)

    # ---------------------------------
    def update_answer_display(self, instance, value):
        self.answer_display.text = rtl_visual(value)

    # ---------------------------------
    def set_answer_and_next(self, value):
        self.text_input.text = value
        self.answers[self.current_index] = value
        self.next_question()

    # ---------------------------------
    def next_question(self, *args):
        self.answers[self.current_index] = self.text_input.text.strip()
        nxt = self.current_index + 1

        if nxt < len(Q_BASE):
            self.build_question(nxt)
        else:
            self.show_summary()

    # -----------------------------------------
    #           סיכום
    # -----------------------------------------
    def show_summary(self, *args):

        lines = []
        lines.append(INTRO_TEXT.rstrip("\n"))
        lines.append("")

        # לפי מבנה המקטעים
        for title, indices in SECTIONS_ORDER:
            lines.append("--------------------")
            lines.append(title)

            for idx in indices:
                num = f"{idx+1}. "
                qtext = Q_BASE[idx]
                ans = self.answers.get(idx, "").strip()

                if ans:
                    lines.append(f"{num}{qtext} {ans}")
                else:
                    lines.append(f"{num}{qtext}")

                lines.append(Q_WEEKLY[idx])
                lines.append(Q_DAILY[idx])
                lines.append("")

        achieved = sum(
            1 for i in range(len(Q_BASE))
            if goal_met(i, self.answers.get(i, ""))
        )

        lines.append(f"כמה מטרות הושגו מתוך 37 מטרות- {achieved}")
        lines.append("מטרה לסוף שבוע ממוצע- 23 (מטרה יומית:19)")

        summary_body = "\n".join(lines)

        # ------------------- הצגה -------------------
        self.root_anchor.clear_widgets()

        wrapper = BoxLayout(orientation="vertical", padding=16, spacing=12)
        self.root_anchor.add_widget(wrapper)

        intro_lbl = Label(
            text=rtl_visual(INTRO_TEXT),
            font_name=FONT_NAME,
            font_size=18,
            halign="right",
            valign="top",
            size_hint=(1, None),
            height=80
        )
        wrapper.add_widget(intro_lbl)

        scroll = ScrollView(size_hint=(1, 0.75))
        self.summary_box = Label(
            text=rtl_visual(summary_body),
            font_name=FONT_NAME,
            font_size=18,
            halign="right",
            valign="top",
            size_hint_y=None
        )
        self.summary_box.bind(texture_size=lambda inst, val: setattr(inst, "height", val[1]))
        scroll.add_widget(self.summary_box)
        wrapper.add_widget(scroll)

        row = BoxLayout(size_hint=(1, None), height=60, spacing=12)

        btn_copy_all = Button(text=rtl_visual("העתק הכל"), font_name=FONT_NAME)
        btn_copy_all.bind(on_press=lambda *a: self.copy_text(summary_body))
        row.add_widget(btn_copy_all)

        btn_copy_no_nums = Button(text=rtl_visual("העתק בלי מספרים"), font_name=FONT_NAME)
        btn_copy_no_nums.bind(on_press=lambda *a: self.copy_text(self.remove_numbers(summary_body)))
        row.add_widget(btn_copy_no_nums)

        wrapper.add_widget(row)

    # ---------------------------------
    def copy_text(self, txt):
        Clipboard.copy(txt)
        p = Popup(
            title="",
            content=Label(text=rtl_visual("הועתק!"), font_name=FONT_NAME, font_size=22),
            size_hint=(None, None), size=(260, 140)
        )
        p.open()
        Clock.schedule_once(lambda dt: p.dismiss(), 1.2)

    # ---------------------------------
    def remove_numbers(self, txt):
        return "\n".join([
            re.sub(r'^\s*\d+\.\s*', '', l)
            for l in txt.splitlines()
        ])


if __name__ == "__main__":
    HebrewApp().run()
