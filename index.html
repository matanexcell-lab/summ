from kivy.config import Config
Config.set('kivy', 'keyboard_mode', 'systemanddock')

from kivy.app import App
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.anchorlayout import AnchorLayout
from kivy.uix.label import Label
from kivy.uix.textinput import TextInput
from kivy.uix.button import Button
from kivy.core.text import LabelBase
from kivy.core.clipboard import Clipboard
from kivy.clock import Clock
from kivy.uix.scrollview import ScrollView
from kivy.uix.popup import Popup
from kivy.core.window import Window  # ← בשביל גובה המקלדת

import os, re
from datetime import datetime, date, timedelta, timezone

# ---------- RTL helper ----------
PAIR_MAP = str.maketrans("()[]{}<>«»‹›", ")(][}{><»«›‹")

def rtl_visual(s: str) -> str:
    if not s:
        return ""
    out = []
    for line in s.split("\n"):
        if any('\u0590' <= ch <= '\u05FF' for ch in line):
            acc = ""
            token = ""
            for ch in line:
                if ch.isdigit() or ch == ":":
                    token += ch
                else:
                    if token:
                        acc = token + acc
                        token = ""
                    acc = ch.translate(PAIR_MAP) + acc
            if token:
                acc = token + acc
            out.append(acc)
        else:
            out.append(line)
    return "\n".join(out)


# ---------- Font ----------
try:
    BASE_DIR = os.path.dirname(os.path.abspath(__file__))
except NameError:
    BASE_DIR = os.getcwd()

FONTS_DIR = os.path.join(BASE_DIR, "static")
font_path = os.path.join(FONTS_DIR, "NotoSansHebrew-Regular.ttf")

if os.path.exists(font_path):
    LabelBase.register(name="HebrewFont", fn_regular=font_path)
    FONT_NAME = "HebrewFont"
else:
    FONT_NAME = "Roboto"


# ---------- Google Calendar (Service Account) ----------
try:
    from google.oauth2.service_account import Credentials
    from googleapiclient.discovery import build
    GOOGLE_CAL_AVAILABLE = True
except ImportError:
    GOOGLE_CAL_AVAILABLE = False

SERVICE_ACCOUNT_FILE = os.path.join(
    BASE_DIR,
    "calendar_credentials.json"
)

CALENDAR_ID = "matanexcell@gmail.com"
CALENDAR_SCOPES = ["https://www.googleapis.com/auth/calendar"]


# ---------- שאלות ----------
Q_BASE = [
    "האם היה 10 שעונים מעוררים עד 10-",
    "בקבוק מים ליד המיטה-",
    "האם היה תכנון של היום עם תזכורות-",
    "מתי הלכת לישון אתמול-",
    "קריאת הגנות ופרסים-",
    "האם היה עבודה אחרי 11:30 בלילה-",
    "קריאה ביומן בבוקר-",
    "מתי קמת-",
    "תיעוד הלילה וניתוחו-",
    "כתיבה עצמית בבוקר (10 דקות עם הקפה)-",
    "סרטון מוטביציה בבוקר-",
    "משקל ששקלת בבוקר-",
    "כדור-",
    "ויטמין D-",
    "האם היה טלפון/טלווזיה בלילה-",
    "זמן טלפון בבוקר-",
    "קריאה באמצע היום-",
    "לימוד תורה-",
    "מה למדת היום (עשרה דברים)-",
    "כושר 16:00 דקות-",
    "מטלות-",
    "לימוד אנגלית-",
    "הכתבה 20 דקות-",
    "עשיית דברים-",
    "דיבור עם חברים 20 דקות-",
    "רימונים-",
    "כדור-",
    "חטא-",
    "אכילת מתוק-",
    "שתית קפה-",
    "אכילת לחם-",
    "כמה אכלת סלט ירקות-",
    "סיג-",
    "אוכל לפי תפריט-",
    "מה אכלת היום-",
    "כמות גרם חלבון-",
    "כדור-",
    "כמות מים-",
    "עשיית משימות היה-",
    "בזבוזים של אוכל-",
    "כמות זמן שהיית בטלפון ובטלווזיה-",
    "זמן שהיית בפעילות-",
    "תיעוד של היום וניתוחו-",
    "מתי רשמת את סיכום היום-",
]

# ---------- כותרות מקטעים ----------
SECTIONS_ORDER = [
    ("דברים צריך לכתוב בלילה שלפני", [0,1,2,3,4,5]),
    ("דברים שצריך לכתוב בבוקר",      [6,7,8,9,10,11,12,13,14,15]),
    ("דברים שצריכים לכתוב בזמן שהם קורים", [16]),
    ("מטלות",                         [17,18,19,20,21,22,23,24,25,26]),
    ("ארבע העייפות",                  [27,28,29]),
    ("דברים שצריכים להיכתב בערב",    [30,31,32,33,34,35,36,37,38,39,40,41,42,43]),
]

# ---------- מטרות שבועיות ----------
Q_WEEKLY = [
    "מטרה לסוף השבוע- מטרה לסוף שבוע 7 היה היה",
    "מטרה לסוף השבוע- 5 היה (מטרה יומית- היה)",
    "מטרה לסוף השבוע- 5 היה (מטרה יומית- היה)",
    "מטרה לסוף שבוע ויומי- 25:00",
    "מטרה לסוף השבוע- 5 היה (מטרה יומית- היה)",
    "מטרה לסוף השבוע 5 לא היה (מטרה יומית- לא היה)",
    "מטרה לסוף השבוע- 5 היה (מטרה יומית- היה)",
    "מטרה לסוף השבוע ממוצע- 09:30 (מטרה יומית: מתחת ל09:30)",
    "מטרה לסוף השבוע- ממוצע של 1.5 (מטרה יומית 1 או מתחת)",
    "מטרה לסוף השבוע- 5 היה (מטרה יומית- היה)",
    "מטרה לסוף השבוע- 3 פעמים (מטרה יומית היה)",
    "מטרה לסוף השבוע- 3 פעמים (מטרה יומית היה)",
    "מטרה לסוף השבוע- 14 (מטרה יומית- היה)",
    "מטרה לסוף השבוע- 7 פעמים היה (מטרה יומית- היה)",
    "מטרה לסוף השבוע- 3 היה או מתחת (מטרה יומית- לא היה)",
    "מטרה לסוף השבוע ממוצע- 00:20 (מטרה יומית 00:20 או מתחת)",
    "מטרה לסוף השבוע- 7 פעמים היה (מטרה יומית היה)",
    "מטרה לסוף השבוע- 7 פעמים היה (מטרה יומית היה)",
    "מטרה לסוף השבוע- 7 פעמים היה (מטרה יומית היה)",
    "מטרה לסוף השבוע- 3 פעמים היה (מטרה יומית היה)",
    "מטרה לסוף השבוע- 2 היה (מטרה יומית: היה)",
    "מטרה לסוף השבוע- 7 פעמים היה (מטרה יומית היה)",
    "מטרה לסוף השבוע- 7 פעמים היה (מטרה יומית היה)",
    "מטרה לסוף השבוע- 3 פעמים היה (מטרה יומית היה)",
    "מטרה לסוף השבוע- 3 פעמים היה (מטרה יומית- היה)",
    "מטרה לסוף השבוע- 3 פעמים היה (מטרה יומית: היה)",
    "מטרה לסוף השבוע- 7 היה (מטרה יומית- היה)",
    "מטרה לסוף השבוע ממוצע- 0.42 (מטרה יומית- לא היה אלא אם זה במטרת עשיית דברים)",
    "מטרה לסוף השבוע ממוצע- 0.42 (מטרה יומית- לא היה)",
    "מטרה לסוף השבוע ממוצע- 3 (מטרה יומית: מתחת ל3)",
    "מטרה לסוף השבוע ממוצע- 0.42 (מטרה יומית- לא היה)",
    "מטרה לסוף השבוע ממוצע- 2 (מטרה יומית- 2)",
    "מטרה לסוף השבוע ממוצע- 1 (מטרה יומית 1 או מתחת)",
    "מטרה לסוף השבוע- 55 (מטרה יומית- 50)",
    "מטרה לסוף השבוע- 55 (מטרה יומית- 50)",
    "מטרה לסוף השבוע- 55 (מטרה יומית- 50)",
    "מטרה לסוף השבוע- 14 (מטרה יומית- היה)",
    "מטרה לסוף השבוע- 1700 מדוד (מטרה יומית- 1700)",
    "מטרה לסוף השבוע ממוצע- 20 (מטרה יומית- מתחת ל20)",
    "מטרה לסוף השבוע- 01:30 (מטרה יומית- מתחת ל01:30)",
    "מטרה לסוף השבוע ממוצע- 07:30 (מטרה יומית- 07:30)",
    "מטרה לסוף שבוע- ממוצע של 0.6 היה (מטרה יומית- היה)",
    "מטרה לסוף השבוע ממוצע- 24:00 (מטרה יומית- מתחת ל24:00)",
    "מטרה לסוף השבוע ממוצע- 24:00 (מטרה יומית- מתחת ל24:00)",
]

# ---------- מטרות יומיות ----------
Q_DAILY = [
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – מתחת ל-25:00",
    "מטרה יומית – היה",
    "מטרה יומית – לא היה",
    "מטרה יומית – היה",
    "מטרה יומית – מתחת ל-09:30",
    "מטרה יומית – 1 או פחות",
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – יש ערך",
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – לא היה",
    "מטרה יומית – 00:20 או פחות",
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – יש ערך",
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – היה",
    "מטרה יומית – לא היה",
    "מטרה יומית – לא היה",
    "מטרה יומית – 2 או פחות",
    "מטרה יומית – לא היה",
    "מטרה יומית – 2 או יותר",
    "מטרה יומית – 1 או פחות",
    "מטרה יומית – היה",
    "מטרה יומית – יש ערך",
    "מטרה יומית – 55 או יותר",
    "מטרה יומית – היה",
    "מטרה יומית – 1500 או יותר",
    "מטרה יומית – היה",
    "מטרה יומית – 20 או פחות",
    "מטרה יומית – 01:30 או פחות",
    "מטרה יומית – 07:30 או יותר",
    "מטרה יומית – היה",
    "מטרה יומית – 24:00 או פחות",
]

# ---------- כללי בדיקה ----------
GOAL_RULES = [
    ('bool', True),
    ('bool', True),
    ('bool', True),
    ('time_max', "25:00"),
    ('bool', True),
    ('bool', False),
    ('bool', True),
    ('time_max', "09:30"),
    ('num_max', 1.0),
    ('bool', True),
    ('bool', True),
    ('nonempty', None),
    ('bool', True),
    ('bool', True),
    ('bool', False),
    ('time_max', "00:20"),
    ('bool', True),
    ('bool', True),
    ('nonempty', None),
    ('bool', True),
    ('bool', True),
    ('bool', True),
    ('bool', True),
    ('bool', True),
    ('bool', True),
    ('bool', True),
    ('bool', True),
    ('bool', False),
    ('bool', False),
    ('num_max', 2.0),
    ('bool', False),
    ('num_min', 2.0),
    ('num_max', 1.0),
    ('bool', True),
    ('nonempty', None),
    ('num_min', 55.0),
    ('bool', True),
    ('num_min', 1500.0),
    ('bool', True),
    ('num_max', 20.0),
    ('time_max', "01:30"),
    ('time_min', "07:30"),
    ('bool', True),
    ('time_max', "24:00"),
]

INTRO_TEXT = (
    "כל דבר שאתה עושה הופך לנכס!\n"
    "כל דבר שאתה לא עושה הופך להתחייבות!\n"
    "השעה 20 תבוא בכל מקרה והשאלה היא האם יהיה לך דברים טובים לכתוב!\n"
)

# אינדקסים לשאלות מיוחדות
SUMMARY_TIME_INDEX = Q_BASE.index("מתי רשמת את סיכום היום-")
SLEEP_TIME_INDEX   = Q_BASE.index("מתי הלכת לישון אתמול-")


# ------------------- פונקציות עזר -------------------

def parse_time_to_minutes(s: str):
    if not s:
        return None
    m = re.search(r'(\d{1,2}):(\d{2})', s)
    if not m:
        return None
    return int(m.group(1)) * 60 + int(m.group(2))

def extract_number(s: str):
    if not s:
        return None
    m = re.search(r'(\d+(?:\.\d+)?)', s.replace(",", "."))
    return float(m.group(1)) if m else None

def normalize_bool_answer(s: str):
    if not s:
        return None
    if "לא היה" in s:
        return False
    if "היה" in s:
        return True
    return None

def goal_met(i, a):
    rule, param = GOAL_RULES[i]
    a = (a or "").strip()

    if rule == 'bool':
        v = normalize_bool_answer(a)
        return v is not None and v == param

    if rule == 'time_max':
        t = parse_time_to_minutes(param)
        g = parse_time_to_minutes(a)
        return g is not None and g <= t

    if rule == 'time_min':
        t = parse_time_to_minutes(param)
        g = parse_time_to_minutes(a)
        return g is not None and g >= t

    if rule == 'num_max':
        g = extract_number(a)
        return g is not None and g <= param

    if rule == 'num_min':
        g = extract_number(a)
        return g is not None and g >= param

    if rule == 'nonempty':
        return len(a) > 0

    return False

def get_extended_now_hhmm():
    """
    00:00–04:59 → +24 שעות (24–28), מ-05:00 רגיל.
    """
    now = datetime.now()
    h = now.hour
    m = now.minute
    if 0 <= h < 5:
        h += 24
    return f"{h:02d}:{m:02d}"


# --------------------------------------------------
#                האפליקציה
# --------------------------------------------------

class HebrewApp(App):

    def build(self):
        self.answers = {}
        self.current_index = 0
        self.root_anchor = AnchorLayout(anchor_y="top")
        self._summary_full = ""
        self._summary_no_numbers = ""
        self._pending_calendar_text = ""
        self._loaded_event_date = None
        self._summary_time_initialized = False
        self.container = None

        # האזנה לגובה המקלדת
        Window.bind(on_keyboard_height=self._on_keyboard_height)

        return self.build_opening()

    # ----- שינוי padding כשמקלדת נפתחת/נסגרת -----
    def _on_keyboard_height(self, window, height):
        """
        אם height > 0 → מקלדת פתוחה.
        דוחף את כל השאלה עוד קצת למטה.
        """
        if not self.container:
            return
        if height > 0:
            top_pad = 140  # מקלדת פתוחה – דחיפה בינונית (B)
        else:
            top_pad = 100  # מצב רגיל – גם קצת יותר נמוך
        left, _, right, bottom = self.container.padding
        self.container.padding = [left, top_pad, right, bottom]

    # ------------------ הודעה קטנה ------------------
    def show_message(self, msg, duration=1.5):
        p = Popup(
            title="",
            content=Label(
                text=rtl_visual(msg),
                font_name=FONT_NAME,
                font_size=20
            ),
            size_hint=(None, None),
            size=(320, 200)
        )
        p.open()
        Clock.schedule_once(lambda dt: p.dismiss(), duration)

    # ------------------ מסך פתיחה ------------------
    def build_opening(self):
        self.root_anchor.clear_widgets()

        layout = BoxLayout(orientation="vertical", padding=20, spacing=12,
                           size_hint=(1, None), height=520)

        layout.add_widget(Label(
            text=rtl_visual("הדבק כאן את הטקסט שלך (לא חובה):"),
            font_name=FONT_NAME, font_size=24,
            halign="center", valign="middle",
            size_hint=(1, None), height=40
        ))

        self.paste_box = TextInput(
            hint_text=rtl_visual("הדבקה כאן..."),
            font_name=FONT_NAME, font_size=18,
            multiline=True,
            halign="right",
            size_hint=(1, None), height=360
        )
        layout.add_widget(self.paste_box)

        start_btn = Button(
            text=rtl_visual("התחל שאלון"),
            font_name=FONT_NAME,
            size_hint=(1, None), height=56
        )
        start_btn.bind(on_press=self.start_questionnaire)
        layout.add_widget(start_btn)

        load_btn = Button(
            text=rtl_visual("טען סיכום מיומן"),
            font_name=FONT_NAME,
            size_hint=(1, None), height=56
        )
        load_btn.bind(on_press=self.ask_date_and_load)
        layout.add_widget(load_btn)

        self.root_anchor.add_widget(layout)
        return self.root_anchor

    # ---------------------------------
    def parse_pasted(self, raw):
        if not raw:
            return
        lines = [l.strip() for l in raw.splitlines() if l.strip()]
        for i, base in enumerate(Q_BASE):
            for line in lines:
                if base in line:
                    after = line.split(base, 1)[1].strip()
                    if after:
                        self.answers[i] = after
                    break

    # ---------------------------------
    def start_questionnaire(self, *args):
        try:
            self.parse_pasted(self.paste_box.text)
        except:
            pass

        self.root_anchor.clear_widgets()
        anchor = AnchorLayout(anchor_y="top")

        # padding עליון התחלתי 100 (קצת יותר נמוך)
        self.container = BoxLayout(
            orientation="vertical",
            padding=[20, 100, 20, 20],
            spacing=15,
            size_hint=(1, None),
            height=600,
            pos_hint={"top": 1}
        )

        anchor.add_widget(self.container)
        self.root_anchor.add_widget(anchor)

        self.build_question(0)

    # ---------------------------------
    def build_question(self, idx):
        self.container.clear_widgets()
        self.current_index = idx

        # כותרת מקטע
        section_name = None
        for title, indices in SECTIONS_ORDER:
            if idx in indices:
                section_name = title
                break

        if section_name:
            self.container.add_widget(Label(
                text=rtl_visual(section_name),
                font_name=FONT_NAME,
                font_size=26,
                size_hint=(1, None),
                height=48,
                halign="center",
                valign="middle"
            ))

        current_answer = self.answers.get(idx, "")

        # דיפולט שעת סיכום יום (שאלה אחרונה)
        if idx == SUMMARY_TIME_INDEX:
            if (not self._summary_time_initialized) and (not current_answer):
                current_answer = get_extended_now_hhmm()
                self.answers[idx] = current_answer
                self._summary_time_initialized = True

        # דיפולט "מתי הלכת לישון" אם ריק
        if idx == SLEEP_TIME_INDEX and not current_answer:
            current_answer = get_extended_now_hhmm()
            self.answers[idx] = current_answer

        # טקסט השאלה
        self.container.add_widget(Label(
            text=rtl_visual(f"{idx+1}. {Q_BASE[idx]}"),
            font_name=FONT_NAME,
            font_size=26,
            size_hint=(1, None),
            height=60
        ))

        # מטרות
        self.container.add_widget(Label(
            text=rtl_visual(Q_WEEKLY[idx]),
            font_name=FONT_NAME, font_size=18,
            size_hint=(1, None), height=32
        ))
        self.container.add_widget(Label(
            text=rtl_visual(Q_DAILY[idx]),
            font_name=FONT_NAME, font_size=18,
            size_hint=(1, None), height=32
        ))

        # תצוגת תשובה חיה
        self.answer_display = Label(
            text=rtl_visual(current_answer),
            font_name=FONT_NAME, font_size=20,
            size_hint=(1, None), height=40
        )
        self.container.add_widget(self.answer_display)

        # שדה הקלדה
        self.text_input = TextInput(
            text=current_answer,
            font_name=FONT_NAME,
            font_size=20,
            multiline=False,
            halign="right",
            size_hint=(1, None),
            height=56
        )
        self.text_input.bind(text=self.update_answer_display)
        self.text_input.bind(on_text_validate=self.next_question)
        self.container.add_widget(self.text_input)

        # כפתורי זמן מיוחדים לשאלת השינה
        if idx == SLEEP_TIME_INDEX:
            row_sleep = BoxLayout(size_hint=(1, None), height=60, spacing=10)

            def make_plus_btn(label, delta):
                btn = Button(
                    text=rtl_visual(label),
                    font_name=FONT_NAME
                )
                btn.bind(on_press=lambda inst, d=delta: self.adjust_sleep_time(d))
                return btn

            row_sleep.add_widget(make_plus_btn("+5", 5))
            row_sleep.add_widget(make_plus_btn("+10", 10))
            row_sleep.add_widget(make_plus_btn("+15", 15))
            row_sleep.add_widget(make_plus_btn("+20", 20))

            btn_free = Button(
                text=rtl_visual("חופשי"),
                font_name=FONT_NAME
            )

            def on_free(instance):
                Clock.schedule_once(
                    lambda dt: setattr(self.text_input, "focus", True), 0.05
                )

            btn_free.bind(on_press=on_free)
            row_sleep.add_widget(btn_free)

            self.container.add_widget(row_sleep)

        # פוקוס לשדה
        Clock.schedule_once(lambda dt: setattr(self.text_input, "focus", True), 0.1)

        # כפתורי היה/לא היה
        row_yesno = BoxLayout(size_hint=(1, None), height=60, spacing=20)
        btn_yes = Button(text=rtl_visual("היה"), font_name=FONT_NAME)
        btn_no = Button(text=rtl_visual("לא היה"), font_name=FONT_NAME)
        btn_yes.bind(on_press=lambda *a: self.set_answer_and_next("היה"))
        btn_no.bind(on_press=lambda *a: self.set_answer_and_next("לא היה"))
        row_yesno.add_widget(btn_yes)
        row_yesno.add_widget(btn_no)
        self.container.add_widget(row_yesno)

        # מעבר למקטע אחר
        btn_section = Button(
            text=rtl_visual("מעבר למקטע אחר"),
            font_name=FONT_NAME,
            size_hint=(1, None), height=60
        )
        btn_section.bind(on_press=self.open_section_menu)
        self.container.add_widget(btn_section)

        # ניווט
        nav_row = BoxLayout(size_hint=(1, None), height=90, spacing=18)

        btn_prev = Button(
            text=rtl_visual("שאלה קודמת"),
            font_name=FONT_NAME, size_hint=(1, None), height=80
        )
        btn_prev.bind(on_press=self.prev_question)
        nav_row.add_widget(btn_prev)

        btn_next = Button(
            text=rtl_visual("לשאלה הבאה"),
            font_name=FONT_NAME, size_hint=(1, None), height=80
        )
        btn_next.bind(on_press=self.next_question)
        nav_row.add_widget(btn_next)

        btn_finish = Button(
            text=rtl_visual("סיום השאלון"),
            font_name=FONT_NAME, size_hint=(1, None), height=80
        )
        btn_finish.bind(on_press=self.show_summary)
        nav_row.add_widget(btn_finish)

        self.container.add_widget(nav_row)

    # -------- כפתורי זמן לשינה --------
    def adjust_sleep_time(self, delta_minutes):
        txt = (self.text_input.text or "").strip()
        m = re.search(r'(\d{1,2}):(\d{2})', txt)
        if m:
            h = int(m.group(1))
            mins = int(m.group(2))
        else:
            now_str = get_extended_now_hhmm()
            h = int(now_str[:2])
            mins = int(now_str[3:])

        total = h * 60 + mins + delta_minutes
        new_h = total // 60
        new_m = total % 60
        new_val = f"{new_h:02d}:{new_m:02d}"

        self.text_input.text = new_val
        self.answers[self.current_index] = new_val
        self.next_question()

    # -------- ניווט למקטע --------
    def open_section_menu(self, *args):
        layout = BoxLayout(orientation="vertical", spacing=12, padding=12)
        for title, indices in SECTIONS_ORDER:
            btn = Button(
                text=rtl_visual(title),
                font_name=FONT_NAME,
                size_hint=(1, None),
                height=60
            )
            btn.bind(on_press=lambda inst, q=indices[0]: self.jump_to_section(q))
            layout.add_widget(btn)

        popup = Popup(
            title=rtl_visual("בחר מקטע"),
            size_hint=(0.8, 0.8),
            content=layout
        )
        self._section_popup = popup
        popup.open()

    def jump_to_section(self, q_index):
        self._section_popup.dismiss()
        self.build_question(q_index)

    def prev_question(self, *args):
        if self.current_index > 0:
            self.answers[self.current_index] = self.text_input.text.strip()
            self.build_question(self.current_index - 1)

    def update_answer_display(self, instance, value):
        self.answer_display.text = rtl_visual(value)

    def set_answer_and_next(self, value):
        self.text_input.text = value
        self.answers[self.current_index] = value
        self.next_question()

    def next_question(self, *args):
        self.answers[self.current_index] = self.text_input.text.strip()
        nxt = self.current_index + 1
        if nxt < len(Q_BASE):
            self.build_question(nxt)
        else:
            self.show_summary()

    # -------- סיכום --------
    def show_summary(self, *args):
        lines = []
        lines.append(INTRO_TEXT.rstrip("\n"))
        lines.append("")

        for title, indices in SECTIONS_ORDER:
            lines.append("--------------------")
            lines.append(title)

            for idx in indices:
                num = f"{idx+1}. "
                qtext = Q_BASE[idx]
                ans = self.answers.get(idx, "").strip()

                if ans:
                    lines.append(f"{num}{qtext} {ans}")
                else:
                    lines.append(f"{num}{qtext}")

                lines.append(Q_WEEKLY[idx])
                lines.append(Q_DAILY[idx])
                lines.append("")

        achieved = sum(
            1 for i in range(len(Q_BASE))
            if goal_met(i, self.answers.get(i, ""))
        )

        lines.append(f"כמה מטרות הושגו מתוך 37 מטרות- {achieved}")
        lines.append("מטרה לסוף שבוע ממוצע- 23 (מטרה יומית:19)")

        summary_body = "\n".join(lines)

        self._summary_full = summary_body
        self._summary_no_numbers = self.remove_numbers(summary_body)

        self.root_anchor.clear_widgets()

        wrapper = BoxLayout(orientation="vertical", padding=16, spacing=12)
        self.root_anchor.add_widget(wrapper)

        intro_lbl = Label(
            text=rtl_visual(INTRO_TEXT),
            font_name=FONT_NAME,
            font_size=18,
            halign="right",
            valign="top",
            size_hint=(1, None),
            height=80
        )
        wrapper.add_widget(intro_lbl)

        scroll = ScrollView(size_hint=(1, 0.75))
        self.summary_box = Label(
            text=rtl_visual(summary_body),
            font_name=FONT_NAME,
            font_size=18,
            halign="right",
            valign="top",
            size_hint_y=None
        )
        self.summary_box.bind(texture_size=lambda inst, val: setattr(inst, "height", val[1]))
        scroll.add_widget(self.summary_box)
        wrapper.add_widget(scroll)

        row = BoxLayout(size_hint=(1, None), height=60, spacing=12)

        btn_copy_all = Button(
            text=rtl_visual("העתק עם מספרים + יומן"),
            font_name=FONT_NAME
        )
        btn_copy_all.bind(
            on_press=lambda *a: self.ask_date_and_send(self._summary_full)
        )
        row.add_widget(btn_copy_all)

        btn_copy_no_nums = Button(
            text=rtl_visual("העתק בלי מספרים + יומן"),
            font_name=FONT_NAME
        )
        btn_copy_no_nums.bind(
            on_press=lambda *a: self.ask_date_and_send(self._summary_no_numbers)
        )
        row.add_widget(btn_copy_no_nums)

        wrapper.add_widget(row)

    def copy_text(self, txt):
        Clipboard.copy(txt)
        self.show_message("הטקסט הועתק")

    def remove_numbers(self, txt):
        return "\n".join([
            re.sub(r'^\s*\d+\.\s*', '', l)
            for l in txt.splitlines()
        ])

    # -------- בחירת תאריך + שליחה ליומן --------
    def ask_date_and_send(self, txt_for_calendar):
        self._pending_calendar_text = txt_for_calendar

        if self._loaded_event_date is not None:
            self.send_to_calendar(self._loaded_event_date, self._pending_calendar_text)
            return

        content = BoxLayout(orientation="vertical", padding=12, spacing=8)

        lbl = Label(
            text=rtl_visual("בחר תאריך לסיכום יום (פורמט yyyy-mm-dd):"),
            font_name=FONT_NAME,
            font_size=18,
            size_hint=(1, None),
            height=60
        )
        content.add_widget(lbl)

        today = date.today()
        default_str = today.strftime("%Y-%m-%d")

        txt_input = TextInput(
            text=default_str,
            multiline=False,
            halign="center",
            font_name=FONT_NAME,
            font_size=20,
            size_hint=(1, None),
            height=50
        )
        content.add_widget(txt_input)

        row1 = BoxLayout(size_hint=(1, None), height=50, spacing=10)

        btn_today = Button(text=rtl_visual("היום"), font_name=FONT_NAME)
        btn_yesterday = Button(text=rtl_visual("אתמול"), font_name=FONT_NAME)

        def set_today(instance):
            d = date.today()
            txt_input.text = d.strftime("%Y-%m-%d")

        def set_yesterday(instance):
            d = date.today() - timedelta(days=1)
            txt_input.text = d.strftime("%Y-%m-%d")

        btn_today.bind(on_press=set_today)
        btn_yesterday.bind(on_press=set_yesterday)

        row1.add_widget(btn_today)
        row1.add_widget(btn_yesterday)
        content.add_widget(row1)

        row2 = BoxLayout(size_hint=(1, None), height=50, spacing=10)

        btn_ok = Button(text=rtl_visual("אישור"), font_name=FONT_NAME)
        btn_cancel = Button(text=rtl_visual("ביטול"), font_name=FONT_NAME)

        popup = Popup(
            title=rtl_visual("בחירת תאריך"),
            content=content,
            size_hint=(0.9, None),
            height=260
        )

        def on_ok(instance):
            raw = txt_input.text.strip()
            try:
                y, m, d = map(int, raw.split("-"))
                chosen_date = date(y, m, d)
            except Exception:
                self.show_message("תאריך לא תקין, השתמש בפורמט yyyy-mm-dd", duration=2.5)
                return

            popup.dismiss()
            self.send_to_calendar(chosen_date, self._pending_calendar_text)

        def on_cancel(instance):
            popup.dismiss()

        btn_ok.bind(on_press=on_ok)
        btn_cancel.bind(on_press=on_cancel)

        row2.add_widget(btn_ok)
        row2.add_widget(btn_cancel)
        content.add_widget(row2)

        popup.open()

    def send_to_calendar(self, chosen_date: date, text: str):
        Clipboard.copy(text)

        if not GOOGLE_CAL_AVAILABLE:
            self.show_message("Google Calendar API לא מותקן", duration=3)
            return

        if not os.path.exists(SERVICE_ACCOUNT_FILE):
            self.show_message("לא נמצא calendar_credentials.json", duration=3)
            return

        try:
            creds = Credentials.from_service_account_file(
                SERVICE_ACCOUNT_FILE,
                scopes=CALENDAR_SCOPES
            )
            service = build("calendar", "v3", credentials=creds)
        except Exception as e:
            self.show_message("שגיאה בחיבור ליומן:\n" + str(e)[:120], duration=3.5)
            return

        tz = timezone(timedelta(hours=2))

        start_dt = datetime(
            chosen_date.year, chosen_date.month, chosen_date.day,
            22, 0, tzinfo=tz
        )
        end_dt = datetime(
            chosen_date.year, chosen_date.month, chosen_date.day,
            23, 0, tzinfo=tz
        )

        time_min = datetime(
            chosen_date.year, chosen_date.month, chosen_date.day,
            0, 0, tzinfo=tz
        )
        time_max = datetime(
            chosen_date.year, chosen_date.month, chosen_date.day,
            23, 59, 59, tzinfo=tz
        )

        try:
            events_result = service.events().list(
                calendarId=CALENDAR_ID,
                timeMin=time_min.isoformat(),
                timeMax=time_max.isoformat(),
                singleEvents=True,
                orderBy="startTime",
                q="סיכום יום"
            ).execute()

            items = events_result.get("items", [])
            existing = None
            for ev in items:
                if ev.get("summary") == "סיכום יום":
                    existing = ev
                    break

            if existing:
                existing["description"] = text
                service.events().update(
                    calendarId=CALENDAR_ID,
                    eventId=existing["id"],
                    body=existing
                ).execute()
                self.show_message("האירוע 'סיכום יום' עודכן ביומן", duration=2.0)
            else:
                body = {
                    "summary": "סיכום יום",
                    "description": text,
                    "start": {"dateTime": start_dt.isoformat()},
                    "end": {"dateTime": end_dt.isoformat()},
                }
                service.events().insert(
                    calendarId=CALENDAR_ID,
                    body=body
                ).execute()
                self.show_message("האירוע 'סיכום יום' נוצר ביומן", duration=2.0)

        except Exception as e:
            self.show_message("שגיאה בשליחת האירוע ליומן:\n" + str(e)[:120], duration=3.5)

    # -------- טעינת אירוע מהיומן --------
    def ask_date_and_load(self, *args):
        content = BoxLayout(orientation="vertical", padding=12, spacing=8)

        lbl = Label(
            text=rtl_visual("בחר תאריך לטעינת סיכום יום (yyyy-mm-dd):"),
            font_name=FONT_NAME,
            font_size=18,
            size_hint=(1, None),
            height=60
        )
        content.add_widget(lbl)

        today = date.today()
        default_str = today.strftime("%Y-%m-%d")

        txt_input = TextInput(
            text=default_str,
            multiline=False,
            halign="center",
            font_name=FONT_NAME,
            font_size=20,
            size_hint=(1, None),
            height=50
        )
        content.add_widget(txt_input)

        row1 = BoxLayout(size_hint=(1, None), height=50, spacing=10)

        btn_today = Button(text=rtl_visual("היום"), font_name=FONT_NAME)
        btn_yesterday = Button(text=rtl_visual("אתמול"), font_name=FONT_NAME)

        def set_today(instance):
            d = date.today()
            txt_input.text = d.strftime("%Y-%m-%d")

        def set_yesterday(instance):
            d = date.today() - timedelta(days=1)
            txt_input.text = d.strftime("%Y-%m-%d")

        btn_today.bind(on_press=set_today)
        btn_yesterday.bind(on_press=set_yesterday)

        row1.add_widget(btn_today)
        row1.add_widget(btn_yesterday)
        content.add_widget(row1)

        row2 = BoxLayout(size_hint=(1, None), height=50, spacing=10)

        btn_ok = Button(text=rtl_visual("אישור"), font_name=FONT_NAME)
        btn_cancel = Button(text=rtl_visual("ביטול"), font_name=FONT_NAME)

        popup = Popup(
            title=rtl_visual("בחירת תאריך לטעינה"),
            content=content,
            size_hint=(0.9, None),
            height=260
        )

        def on_ok(instance):
            raw = txt_input.text.strip()
            try:
                y, m, d = map(int, raw.split("-"))
                chosen_date = date(y, m, d)
            except Exception:
                self.show_message("תאריך לא תקין, השתמש בפורמט yyyy-mm-dd", duration=2.5)
                return

            popup.dismiss()
            self.load_from_calendar(chosen_date)

        def on_cancel(instance):
            popup.dismiss()

        btn_ok.bind(on_press=on_ok)
        btn_cancel.bind(on_press=on_cancel)

        row2.add_widget(btn_ok)
        row2.add_widget(btn_cancel)
        content.add_widget(row2)

        popup.open()

    def load_from_calendar(self, chosen_date: date):
        if not GOOGLE_CAL_AVAILABLE:
            self.show_message("Google Calendar API לא מותקן", duration=3)
            return

        if not os.path.exists(SERVICE_ACCOUNT_FILE):
            self.show_message("לא נמצא calendar_credentials.json", duration=3)
            return

        try:
            creds = Credentials.from_service_account_file(
                SERVICE_ACCOUNT_FILE,
                scopes=CALENDAR_SCOPES
            )
            service = build("calendar", "v3", credentials=creds)
        except Exception as e:
            self.show_message("שגיאה בחיבור ליומן:\n" + str(e)[:120], duration=3.5)
            return

        tz = timezone(timedelta(hours=2))

        time_min = datetime(
            chosen_date.year, chosen_date.month, chosen_date.day,
            0, 0, tzinfo=tz
        )
        time_max = datetime(
            chosen_date.year, chosen_date.month, chosen_date.day,
            23, 59, 59, tzinfo=tz
        )

        try:
            events_result = service.events().list(
                calendarId=CALENDAR_ID,
                timeMin=time_min.isoformat(),
                timeMax=time_max.isoformat(),
                singleEvents=True,
                orderBy="startTime",
                q="סיכום יום"
            ).execute()

            items = events_result.get("items", [])
            existing = None
            for ev in items:
                if ev.get("summary") == "סיכום יום":
                    existing = ev
                    break

            if not existing:
                self.show_message("לא נמצא אירוע 'סיכום יום' לתאריך הזה", duration=3)
                return

            desc = existing.get("description", "") or ""

            self._loaded_event_date = chosen_date
            self.paste_box.text = desc
            self.start_questionnaire()

        except Exception as e:
            self.show_message("שגיאה בטעינה מהיומן:\n" + str(e)[:120], duration=3.5)


if __name__ == "__main__":
    HebrewApp().run()